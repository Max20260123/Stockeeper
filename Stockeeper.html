<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stockeeper v2.0</title>
    <!-- Chart.js æ ¸å¿ƒ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Chart.js æ•¸æ“šæ¨™ç±¤æ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        :root {
            /* --- v1.6 æ ¸å¿ƒé…è‰² --- */
            --bg: #eff2f7;
            --card-bg: #ffffff;
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #eff6ff;
            --success: #10b981;
            --success-light: #ecfdf5;
            --danger: #ef4444;
            --danger-light: #fef2f2;
            --warning: #f59e0b;
            --text-main: #1f2937;
            --text-sec: #6b7280;
            --border: #e5e7eb;
            --table-head-bg: #f8fafc;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;

            /* --- v2.0 æ¨¡æ“¬å™¨æ–°å¢é…è‰² (ç´«è‰²ç³») --- */
            --sim-primary: #8b5cf6;
            --sim-bg: #f5f3ff;
            --sim-border: #ddd6fe;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0; 
            padding: 30px 20px; 
            background: var(--bg); 
            color: var(--text-main); 
            -webkit-font-smoothing: antialiased; 
            line-height: 1.5;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            display: flex; 
            flex-direction: column; 
            gap: 24px; 
        }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card { 
            background: var(--card-bg); 
            padding: 24px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow-card); 
            border: 1px solid rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden; 
        }
        @media (min-width: 769px) {
            .card::before {
                content: '';
                position: absolute;
                top: 0; left: 0; width: 100%; height: 3px;
                background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            }
        }

        h3 { 
            margin-top: 0; 
            border-bottom: 2px solid var(--border); 
            padding-bottom: 15px; 
            font-size: 1.2rem; 
            color: #111827; 
            font-weight: 700;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            letter-spacing: -0.025em;
        }
        
        /* é¡è‰²å·¥å…· */
        .text-up { color: var(--success); font-weight: 700; }
        .text-down { color: var(--danger); font-weight: 700; }
        .text-neutral { color: var(--text-sec); }
        .small-text { font-size: 0.85rem; color: var(--text-sec); font-weight: normal; }
        .text-right { text-align: right !important; }
        .text-center { text-align: center !important; }

        /* --- KPI å„€è¡¨æ¿ --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .kpi-box { 
            background: linear-gradient(to bottom right, #ffffff, #f9fafb);
            padding: 20px; 
            border-radius: var(--radius); 
            text-align: left; 
            border: 1px solid var(--border);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .kpi-box::before { content: ''; position: absolute; left: 0; top: 15%; bottom: 15%; width: 4px; border-radius: 0 4px 4px 0; }
        .kpi-box:nth-child(1)::before { background: var(--text-sec); }
        .kpi-box:nth-child(2)::before { background: var(--primary); }
        .kpi-box:nth-child(3)::before { background: var(--success); }
        .kpi-box:nth-child(4)::before { background: var(--warning); }

        .kpi-title { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 4px; font-weight: 600; text-transform: uppercase; padding-left: 12px; }
        .kpi-val { font-size: 1.6rem; font-weight: 800; color: #111827; margin-top: auto; line-height: 1.2; padding-left: 12px; }
        .kpi-sub { padding-left: 12px; margin-top: 5px; }

        /* --- è¡¨æ ¼æ¨£å¼ --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; font-size: 0.95rem; table-layout: fixed; }
        th { 
            text-align: left; 
            padding: 14px 12px; 
            background: #eef2f6; 
            color: #4b5563;
            font-weight: 700;
            cursor: pointer; 
            user-select: none; 
            white-space: nowrap;
            border-bottom: 2px solid #e2e8f0;
            border-top: 1px solid #f1f5f9;
        }
        th:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; border-left: 1px solid #f1f5f9; }
        th:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-right: 1px solid #f1f5f9; }
        
        td { 
            padding: 14px 12px; 
            border-bottom: 1px solid #f3f4f6; 
            vertical-align: middle; 
            color: var(--text-main);
            transition: background 0.1s;
        }
        tr:last-child td { border-bottom: none; }
        
        @media (min-width: 769px) {
            tbody tr:hover td { background: #f8fafc; }
            .clickable-row:hover td { cursor: pointer; background: #f1f5f9 !important; }
            .desktop-only { display: table-cell !important; }
        }

        .clickable-row { cursor: pointer; }
        .detail-row { background-color: #fafafa !important; display: none; }
        .detail-content { padding: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; font-size: 0.9rem; color: var(--text-sec); border-top: 1px solid var(--border); box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        .detail-item strong { display: block; color: var(--text-main); margin-bottom: 4px; font-size: 1rem; }

        /* æ­·å²è¨˜éŒ„æ¨£å¼ */
        #history-table { font-size: 0.9rem; }
        .history-month-row { background: #e0e7ff !important; color: var(--primary-dark); font-weight: bold; font-size: 0.95rem; }
        .history-month-row td { padding-top: 15px; padding-bottom: 8px; border-bottom: 1px solid #c7d2fe; }
        
        /* æ’åºåœ–ç¤º */
        .sort-icon::after { content: ' â†•'; font-size: 0.8em; color: #cbd5e1; margin-left: 5px; }
        .sort-asc::after { content: ' â†‘'; color: var(--primary); }
        .sort-desc::after { content: ' â†“'; color: var(--primary); }

        /* è¼¸å…¥æ§ä»¶ */
        input, select, textarea { 
            padding: 10px 12px; 
            border: 1px solid #d1d5db; 
            border-radius: 8px; 
            width: 100%; 
            box-sizing: border-box; 
            transition: all 0.2s; 
            font-size: 0.95rem;
            background: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); 
        }

        /* æŒ‰éˆ• */
        .btn { 
            padding: 10px 18px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.95rem; 
            font-weight: 600;
            transition: all 0.2s; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn:active { transform: translateY(1px); box-shadow: none; }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4); }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: #374151; }
        .btn-outline:hover { background: #f9fafb; border-color: #9ca3af; }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; border-radius: 6px; }
        .btn-row { display: flex; gap: 12px; margin-top: 20px; }

        /* å¾½ç«  */
        .badge { display: inline-block; width: 22px; height: 22px; line-height: 22px; text-align: center; border-radius: 50%; font-size: 0.75rem; color: white; font-weight: bold; margin-right: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .bg-gold { background: linear-gradient(135deg, #fbbf24, #d97706); }
        .bg-gray { background: linear-gradient(135deg, #9ca3af, #4b5563); }
        .bg-bronze { background: linear-gradient(135deg, #d97706, #92400e); }
        
        .import-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }

        /* --- æ¨¡æ“¬å™¨å°ˆç”¨æ¨£å¼ --- */
        .sim-card { border: 2px solid var(--sim-primary); background: #fff; }
        .sim-control-panel { display: grid; grid-template-columns: 1fr 1fr 0.8fr 0.8fr auto; gap: 10px; align-items: end; background: var(--sim-bg); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px dashed var(--sim-border); }
        .btn-sim { background: var(--sim-primary); color: white; }
        .btn-sim:hover { background: #7c3aed; }
        .sim-list { margin-bottom: 20px; }
        .sim-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; gap: 10px; flex-wrap: wrap; background: #fafafa; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border); }
        .sim-tag { background: var(--sim-bg); color: var(--sim-primary); padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.95rem; }
        .sim-manual-box { display: flex; gap: 10px; align-items: center; flex: 1; flex-wrap: wrap; }
        .sim-manual-btn { border: 1px dashed var(--sim-primary); color: var(--sim-primary); background: transparent; padding: 4px 8px; font-size: 0.8rem; cursor: pointer; border-radius: 4px; }
        .sim-manual-btn:hover { background: var(--sim-bg); }

        /* æ¨¡æ“¬å™¨çµæœè¡¨æ ¼æ¨£å¼ */
        .sim-result-table-container { margin-top: 20px; overflow-x: auto; }
        .sim-result-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .sim-result-table th { background: var(--sim-bg); color: var(--sim-primary); border-top: 1px solid var(--sim-border); border-bottom: 2px solid var(--sim-border); padding: 10px; cursor: pointer; }
        .sim-result-table td { border-bottom: 1px solid #eee; padding: 10px; vertical-align: middle; }
        .sim-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--sim-primary); }
        
        /* æ¨¡æ“¬å™¨å±•é–‹æ˜ç´°æ¨£å¼ */
        .sim-detail-row { display: none; background: #fcfaff; }
        .sim-detail-row.expanded { display: table-row; }
        .sim-detail-inner-table { width: 95%; margin: 10px auto; border: 1px solid #eee; background: white; font-size: 0.85rem; }
        .sim-detail-inner-table th { background: #eee; color: #555; padding: 5px; text-align: right; border-bottom: 1px solid #ddd; }
        .sim-detail-inner-table td { padding: 5px; text-align: right; border-bottom: 1px solid #f5f5f5; color: #666; }

        /* --- ğŸ“± ç§»å‹•ç«¯å°ˆå±¬å„ªåŒ– --- */
        @media (max-width: 768px) {
            body { padding: 10px 0px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); background: #f9fafb; }
            .container { gap: 10px; width: 100%; max-width: 100%; overflow-x: hidden; }
            
            .card { padding: 15px; border-radius: 0; box-shadow: none; border: none; border-bottom: 10px solid #f0f2f5; }
            .card:last-child { border-bottom: none; }
            .card::before { display: none; }
            
            h3 { font-size: 1.1rem; padding-bottom: 10px; border-bottom: 1px solid #f3f4f6; }
            input, select, textarea { font-size: 16px !important; padding: 8px; }

            .dashboard-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .kpi-box { padding: 15px 10px; min-height: 80px; justify-content: flex-start; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
            .kpi-box::before { width: 3px; top: 10%; bottom: 10%; }
            .kpi-val { font-size: 1.25rem; padding-left: 10px; }
            .kpi-title { font-size: 0.75rem; padding-left: 10px; }
            .kpi-sub { padding-left: 10px; font-size: 0.7rem; }

            .grid-charts { grid-template-columns: 1fr !important; display: block !important; }
            .grid-charts > div { height: 250px !important; margin-bottom: 20px; box-shadow: none !important; border: 1px solid #f3f4f6; }
            .import-grid { grid-template-columns: 1fr !important; }
            .btn-row { flex-direction: column; }
            .btn { width: 100%; padding: 12px; font-size: 1rem; }
            .btn-sm { width: auto; padding: 6px 10px; }
            .detail-content { grid-template-columns: 1fr !important; gap: 12px; padding: 15px; }
            
            #batch-input-table th, #batch-input-table td { padding: 8px 4px; font-size: 0.85rem; }
            .desktop-only { display: none !important; }

            /* å¡ç‰‡å¼è¡¨æ ¼ */
            .full-bleed-mobile { margin-left: -15px; margin-right: -15px; width: calc(100% + 30px); border-top: 1px solid #f3f4f6; }
            .mobile-card-table { display: block; width: 100%; margin-top: 0; }
            .mobile-card-table thead { display: none; }
            .mobile-card-table tbody tr.clickable-row, .mobile-card-table tbody tr.history-item-row { display: block; background: #fff; border-bottom: 1px solid #f0f0f0; padding: 12px 15px; position: relative; }
            .mobile-card-table tbody tr:hover td { background: transparent !important; }
            .mobile-card-table tbody tr.history-month-row { display: block; padding: 10px 15px; background: #f8fafc !important; border-bottom: 1px solid #e5e7eb; }
            .mobile-card-table td { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: none; text-align: right; font-size: 0.95rem; width: 100%; box-sizing: border-box; }
            .mobile-card-table td::before { content: attr(data-label); font-weight: normal; color: #9ca3af; font-size: 0.85rem; margin-right: 15px; text-align: left; flex-shrink: 0; }
            
            .mobile-card-table td[data-label="è‚¡ç¥¨"], .mobile-card-table td[data-label="æ—¥æœŸ"] { padding-bottom: 10px; margin-bottom: 5px; border-bottom: 1px dashed #f3f4f6; font-size: 1.05rem; text-align: left; }
            .mobile-card-table td[data-label="è‚¡ç¥¨"]::before, .mobile-card-table td[data-label="æ—¥æœŸ"]::before { display: none; }
            .mobile-card-table td[data-label="è‚¡ç¥¨"]::after { content: 'â–¼'; color: #e5e7eb; font-size: 0.8rem; margin-left: auto; }
            .mobile-card-table tr.expanded td[data-label="è‚¡ç¥¨"]::after { transform: rotate(180deg); color: var(--primary); }
            
            .mobile-card-table td.mobile-hidden { display: none; }
            .mobile-card-table tr.expanded td.mobile-hidden { display: flex; animation: fadeIn 0.2s ease-in; background: #f9fafb; padding: 10px; margin: 4px 0; border-radius: 8px; border: 1px solid #f3f4f6; }
            .mobile-card-table input[type="number"] { width: 120px; text-align: right; border: 1px solid #e5e7eb; padding: 8px; background: #fff; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
            
            /* æ¨¡æ“¬å™¨æ‰‹æ©Ÿæ¨£å¼ */
            .sim-control-panel { grid-template-columns: 1fr 1fr; }
            .sim-control-panel button { grid-column: span 2; }
            .sim-manual-box { width: 100%; flex-direction: column; align-items: stretch; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }

            /* æ¨¡æ“¬å™¨çµæœè¡¨æ ¼æ‰‹æ©Ÿæ¨£å¼ */
            .sim-result-table th, .sim-result-table td { padding: 8px 4px; font-size: 0.8rem; white-space: nowrap; }
            .sim-result-table td:nth-child(2) { white-space: normal; min-width: 80px; }
            .sim-detail-inner-table th, .sim-detail-inner-table td { padding: 4px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>

<div class="container">

    <!-- ğŸ”® æ¨¡æ“¬å™¨å¡ç‰‡ -->
    <div class="card sim-card" style="border-left: none; border-top: 4px solid var(--sim-primary);">
        <h3 style="color: var(--sim-primary); border-color: var(--sim-border);">
            ğŸ”® å¤šè‚¡æœˆä¾›å›æ¸¬æ¨¡æ“¬å™¨ 
            <span class="small-text">æ•¸æ“šç”± Yahoo æä¾›</span>
        </h3>
        
        <div class="sim-control-panel">
            <div>
                <label class="small-text">è‚¡ç¥¨ä»£è™Ÿ</label>
                <input type="text" id="sim-input-code" placeholder="å¦‚ 0005 (è‡ªå‹•åŠ  .HK)" oninput="this.value=this.value.toUpperCase()">
            </div>
            <div>
                <label class="small-text">æœˆä¾›é‡‘é¡ ($)</label>
                <input type="number" id="sim-input-amt" value="5000">
            </div>
            <div>
                <label class="small-text">é–‹å§‹å¹´ä»½</label>
                <select id="sim-start-year"></select>
            </div>
            <div>
                <label class="small-text">é–‹å§‹æœˆä»½</label>
                <select id="sim-start-month">
                    <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option>
                    <option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
                    <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
                    <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                </select>
            </div>
            <button class="btn btn-sim" onclick="addSimStock()">+ åŠ å…¥çµ„åˆ</button>
        </div>

        <div id="sim-list-container" class="sim-list"></div>

        <div class="btn-row">
            <button class="btn btn-sim" style="width:100%" onclick="runMultiSimulation()">ğŸš€ é–‹å§‹çµ„åˆæ¨¡æ“¬</button>
        </div>

        <!-- æ¨¡æ“¬çµæœ -->
        <div id="sim-result-area" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--sim-border);">
            <!-- KPI æ‘˜è¦ -->
            <div class="dashboard-grid">
                <div class="kpi-box" style="padding:10px; background:var(--sim-bg); border-color:var(--sim-border); min-height: auto;">
                    <div class="kpi-title" style="color:var(--sim-primary)">çµ„åˆç¸½æŠ•å…¥</div>
                    <div class="kpi-val" id="sim-res-cost" style="font-size:1.3rem;">$0</div>
                </div>
                <div class="kpi-box" style="padding:10px; background:var(--sim-bg); border-color:var(--sim-border); min-height: auto;">
                    <div class="kpi-title" style="color:var(--sim-primary)">æœŸæœ«ç¸½å€¼ (ä¼°)</div>
                    <div class="kpi-val" id="sim-res-val" style="font-size:1.3rem;">$0</div>
                </div>
                <div class="kpi-box" style="padding:10px; background:var(--sim-bg); border-color:var(--sim-border); min-height: auto;">
                    <div class="kpi-title" style="color:var(--sim-primary)">ä¼°ç®—å›å ±</div>
                    <div class="kpi-val" id="sim-res-pct" style="font-size:1.3rem;">0%</div>
                </div>
                <div class="kpi-box" style="padding:10px; background:var(--sim-bg); border-color:var(--sim-border); min-height: auto;">
                    <div class="kpi-title" style="color:var(--sim-primary)">ç¸½è‚¡æ¯æ”¶å…¥</div>
                    <div class="kpi-val text-up" id="sim-res-div" style="font-size:1.3rem;">$0</div>
                </div>
            </div>

            <!-- åœ–è¡¨ -->
            <div style="height: 300px; margin-top: 20px;">
                <canvas id="simChart"></canvas>
            </div>

            <!-- è©³ç´°æ¸…å–®èˆ‡ç¯©é¸ -->
            <div class="sim-result-table-container">
                <h4 style="color:var(--sim-primary); margin-bottom:10px;">ğŸ“Š è©³ç´°è¡¨ç¾ (é»æ“Šæ¨™é¡Œæ’åº)</h4>
                <div class="small-text" style="margin-bottom:10px;">é»æ“Šè‚¡ç¥¨è¡Œå¯å±•é–‹æ¯æœˆæ˜ç´°</div>
                <table class="sim-result-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;" class="text-center">é¸</th>
                            <th class="text-left" onclick="sortSimResult('code')">è‚¡ç¥¨ <span class="sort-icon"></span></th>
                            <th class="text-right" onclick="sortSimResult('cost')">ç¸½æŠ•å…¥ <span class="sort-icon"></span></th>
                            <th class="text-right" onclick="sortSimResult('value')">æœŸæœ«å¸‚å€¼ <span class="sort-icon"></span></th>
                            <th class="text-right" onclick="sortSimResult('div')">ç¸½è‚¡æ¯ <span class="sort-icon"></span></th>
                            <th class="text-right" onclick="sortSimResult('net')">æ·¨å›å ± <span class="sort-icon"></span></th>
                        </tr>
                    </thead>
                    <tbody id="sim-detail-tbody">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- KPI å€åŸŸ -->
    <div class="card">
        <h3>ğŸ“Š æŠ•è³‡çµ„åˆç¸½è¦½</h3>
        <div class="dashboard-grid">
            <div class="kpi-box">
                <div>
                    <div class="kpi-title">ç¸½æŠ•å…¥æˆæœ¬ (æœ¬é‡‘)</div>
                    <div class="small-text kpi-sub">(å«äº¤æ˜“æ‰‹çºŒè²»)</div>
                </div>
                <div class="kpi-val" id="kpi-cost" style="color:var(--text-sec)">$0.00</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-title">ç•¶å‰æŒå€‰å¸‚å€¼</div>
                <div class="kpi-val" id="kpi-market" style="color:var(--primary)">$0.00</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-title">ç¸½å·²æ”¶è‚¡æ¯</div>
                <div class="kpi-val text-up" id="kpi-div" style="color:var(--success)">$0.00</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-title">æ·¨å›å ± (å«å·²å¯¦ç¾æç›Š)</div>
                <div class="kpi-val" id="kpi-pnl" style="color:var(--warning)">$0.00</div>
                <div class="small-text kpi-sub" id="kpi-pnl-pct" style="font-weight:bold;">0.00%</div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢äº¤æ˜“ -->
    <div class="card" style="border-left: 5px solid var(--primary);">
        <h3>ğŸ“ æ–°å¢äº¤æ˜“ / æ”¶æ¯è¨˜éŒ„</h3>
        
        <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label class="small-text" style="display:block; margin-bottom:5px;">æ—¥æœŸ</label>
                <input type="date" id="batch-date">
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label class="small-text" style="display:block; margin-bottom:5px;">è©²æ¬¡ç¸½æ‰‹çºŒè²» ($)</label>
                <input type="number" id="batch-fee" value="50">
            </div>
        </div>

        <table id="batch-input-table">
            <thead>
                <tr>
                    <th style="width: 20%">é¡å‹</th>
                    <th style="width: 20%">ä»£è™Ÿ</th>
                    <th style="width: 25%">é‡‘é¡ / å–®åƒ¹</th>
                    <th style="width: 20%">è‚¡æ•¸</th>
                    <th style="width: 15%">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="batch-body"></tbody>
        </table>
        
        <div class="btn-row">
            <button class="btn btn-outline" onclick="addBatchRow()">+ åŠ å…¥ä¸€è¡Œ</button>
            <button class="btn btn-primary" onclick="saveBatchTransaction()">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨˜éŒ„</button>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œ -->
    <div class="card">
        <h3>ğŸ† è‚¡ç¥¨è¡¨ç¾æ’è¡Œæ¦œ <span class="small-text" style="font-weight: normal;">å«å·²å¯¦ç¾æç›Š (è³£å‡ºè³ºè•)</span></h3>
        <div class="small-text" style="margin-bottom: 15px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; color: #4b5563;">
            * <b>è‚¡æ¯ç‡ (Yield)</b> = ç¸½è‚¡æ¯ / æ­·å²ç¸½æŠ•å…¥æˆæœ¬ &nbsp;|&nbsp;
            * <b>ç¸½å›å ± (Total)</b> = (å¸‚å€¼ + è‚¡æ¯ + è³£å‡ºå–å› - ç¸½æŠ•å…¥)
        </div>
        <div class="full-bleed-mobile">
            <table id="roi-table" class="mobile-card-table">
                <thead>
                    <tr>
                        <th style="width: 20%" onclick="sortRoi('code')">è‚¡ç¥¨ <span class="sort-icon"></span></th>
                        <th style="width: 14%" class="text-right" onclick="sortRoi('totalInvested')">ç¸½æŠ•å…¥æˆæœ¬ <span class="sort-icon"></span></th>
                        <th style="width: 12%" class="text-right" onclick="sortRoi('totalDiv')">ç¸½è‚¡æ¯ <span class="sort-icon"></span></th>
                        <th style="width: 10%" class="text-right" onclick="sortRoi('yield')">è‚¡æ¯ç‡ <span class="sort-icon"></span></th>
                        <th style="width: 14%" class="text-right" onclick="sortRoi('realizedPnl')">å·²å¹³å€‰æç›Š <span class="sort-icon"></span></th>
                        <th style="width: 16%" class="text-right" onclick="sortRoi('totalProfit')">ç¸½å›å ± ($) <span class="sort-icon"></span></th>
                        <th style="width: 14%" class="text-right" onclick="sortRoi('totalRetPct')">å›å ±ç‡ (%) <span class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- æŒå€‰ç¾æ³ -->
    <div class="card">
        <h3>
            ğŸ’¼ æŒå€‰ç¾æ³ 
            <button class="btn btn-success btn-sm" onclick="fetchYahooPrices()">ğŸ”„ ç¶²ä¸Šæ›´æ–°ç¾åƒ¹</button>
        </h3>
        <div class="small-text" style="margin-bottom: 10px;">é»æ“Šè‚¡ç¥¨å¯å±•é–‹/æ‘ºç–Šè©³ç´°è³‡æ–™åŠè¼¸å…¥ç¾åƒ¹</div>
        
        <div class="full-bleed-mobile">
            <table id="portfolio-table" class="mobile-card-table">
                <thead>
                    <tr>
                        <th width="24%" onclick="sortPortfolio('code')">è‚¡ç¥¨ <span class="sort-icon"></span></th>
                        <th width="12%" class="text-right" onclick="sortPortfolio('qty')">æŒå€‰è‚¡æ•¸ <span class="sort-icon"></span></th>
                        <th width="14%" class="text-right" onclick="sortPortfolio('avgPrice')">å¹³å‡è²·å…¥åƒ¹ <span class="sort-icon"></span></th>
                        <th width="14%" class="text-right">ç¾åƒ¹ (å¯è¼¸å…¥)</th>
                        <th width="18%" class="text-right" onclick="sortPortfolio('marketVal')">å¸‚å€¼ <span class="sort-icon"></span></th>
                        <th width="18%" class="text-right" onclick="sortPortfolio('paperPnl')">å¸³é¢ç›ˆè™§ <span class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- åœ–è¡¨å€åŸŸ -->
    <div class="card">
        <h3>ğŸ“ˆ è³‡ç”¢è¶¨å‹¢èˆ‡åˆ†ä½ˆ</h3>
        <div class="grid-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div style="height: 300px; padding: 10px; background: #fff; border-radius: 8px; border: 1px solid #f3f4f6;">
                <canvas id="trendChart1"></canvas>
            </div>
            <div style="height: 300px; padding: 10px; background: #fff; border-radius: 8px; border: 1px solid #f3f4f6;">
                <canvas id="trendChart2"></canvas>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;" class="grid-charts">
            <div style="height: 300px; padding: 10px; background: #fff; border-radius: 8px; border: 1px solid #f3f4f6;">
                <canvas id="pieChart"></canvas>
            </div>
            <div style="height: 300px; padding: 10px; background: #fff; border-radius: 8px; border: 1px solid #f3f4f6;">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>

    <!-- åŒ¯å…¥åŠŸèƒ½ -->
    <div class="card" style="border: 2px dashed var(--primary); background: #f0f7ff;">
        <h3>ğŸ“¤ Excel æ•¸æ“šæ‰¹é‡åŒ¯å…¥ (å°ˆæ¥­ç‰ˆé‚è¼¯)</h3>
        <div class="import-grid">
            <div>
                <label style="display:block; margin-bottom:8px; font-weight:600;">1. æœˆä¾›è¨˜éŒ„è¡¨</label>
                <textarea id="excel-buy-area" rows="5" placeholder="è²¼ä¸Šæœˆä¾›è¡¨ç¯„åœ..."></textarea>
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="importBuyData()">åŒ¯å…¥è²·å…¥åŠè‚¡æ¯</button>
            </div>
            <div>
                <label style="display:block; margin-bottom:8px; font-weight:600;">2. è³£å‡ºè‚¡ç¥¨è¡¨</label>
                <textarea id="excel-sell-area" rows="5" placeholder="è²¼ä¸Šè³£å‡ºè¡¨ A1:X4 ç¯„åœ..."></textarea>
                <button class="btn btn-danger" style="width:100%; margin-top:10px;" onclick="importSellData()">åŒ¯å…¥è³£å‡ºè¨˜éŒ„</button>
            </div>
        </div>
    </div>

    <!-- äº¤æ˜“æµæ°´å¸³ -->
    <div class="card">
        <h3>ğŸ—‚ï¸ äº¤æ˜“æµæ°´å¸³ (èˆŠåˆ°æ–°)</h3>
        <div class="full-bleed-mobile" style="max-height: 500px; overflow-y: auto;">
            <table id="history-table" class="mobile-card-table">
                <thead>
                    <tr>
                        <th style="width: 15%">æ—¥æœŸ</th>
                        <th style="width: 15%">ä»£è™Ÿ</th>
                        <th style="width: 10%">å‹•ä½œ</th>
                        <th style="width: 12%" class="text-right">å–®åƒ¹</th>
                        <th style="width: 10%" class="text-right">è‚¡æ•¸</th>
                        <th style="width: 10%" class="text-right">æ‰‹çºŒè²»</th>
                        <th style="width: 15%" class="text-right">ç¸½è®Šå‹•</th>
                        <th style="width: 13%"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="margin-top: 15px; text-align: right; padding: 0 10px;">
            <button class="btn btn-sm btn-danger" onclick="clearAllData()">âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>

</div>

<script>
    // å•Ÿç”¨ Chart.js DataLabels
    Chart.register(ChartDataLabels);

    // --- å…§å»ºè‚¡ç¥¨ä¸­æ–‡åç¨±æ˜ å°„ ---
    const stockMap = {
        "0005.HK": "æ»™è±æ§è‚¡", "0012.HK": "æ’åŸºåœ°ç”¢", "0027.HK": "éŠ€æ²³å¨›æ¨‚",
        "0388.HK": "é¦™æ¸¯äº¤æ˜“æ‰€", "0823.HK": "é ˜å±•æˆ¿ç”¢", "0883.HK": "ä¸­æµ·æ²¹",
        "2638.HK": "æ¸¯ç‡ˆ-SS", "2800.HK": "ç›ˆå¯ŒåŸºé‡‘", "0001.HK": "é•·å’Œ",
        "0003.HK": "ç…¤æ°£", "0011.HK": "æ’ç”ŸéŠ€è¡Œ", "0016.HK": "æ–°é´»åŸº",
        "0066.HK": "æ¸¯éµ", "0700.HK": "é¨°è¨Š", "09988.HK": "é˜¿é‡Œ",
        "03690.HK": "ç¾åœ˜", "01299.HK": "å‹é‚¦", "00939.HK": "å»ºè¡Œ",
        "01398.HK": "å·¥è¡Œ", "03988.HK": "ä¸­è¡Œ"
    };

    function getStockName(code) {
        if(!code) return "";
        let c = code.toUpperCase();
        if(!c.includes('.HK')) c += '.HK';
        let name = stockMap[c] || c;
        if (name.length > 6) name = name.substring(0, 6);
        if (stockMap[c]) return `${c.replace('.HK','')} ${name}`;
        return c;
    }

    // --- å…¨å±€è®Šæ•¸ ---
    let transactions = JSON.parse(localStorage.getItem('stock_v4_trans')) || [];
    let priceCache = JSON.parse(localStorage.getItem('stock_v4_prices')) || {};
    let batchTemplate = JSON.parse(localStorage.getItem('stock_v4_template')) || [];

    // æ’åºç‹€æ…‹
    let portfolioSort = { key: 'marketVal', order: 'desc' };
    let roiSort = { key: 'totalRetPct', order: 'desc' };
    let simSort = { key: 'net', order: 'desc' }; // æ¨¡æ“¬å™¨æ’åº

    document.getElementById('batch-date').valueAsDate = new Date();
    
    // åˆå§‹åŒ–è¼¸å…¥æ¡†
    if (batchTemplate.length > 0) {
        batchTemplate.forEach(item => addBatchRow(item.code, item.qty, 'buy'));
    } else {
        addBatchRow();
    }
    
    // åˆå§‹åŒ–å¹´ä»½é¸é … (1980 - 2025)
    const yearSelect = document.getElementById('sim-start-year');
    const currentYear = new Date().getFullYear();
    for (let y = 1980; y <= currentYear; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.text = y;
        if (y === 2020) opt.selected = true; // é è¨­ 2020
        yearSelect.appendChild(opt);
    }

    let trendChartInst1 = null;
    let trendChartInst2 = null;
    let pieChartInst = null;
    let barChartInst = null;
    let simChartInst = null;

    // --- ğŸ”® æ¨¡æ“¬å™¨è®Šæ•¸ ---
    let simStocks = []; 
    // æ–°å¢ï¼šæš«å­˜æ¨¡æ“¬è¨ˆç®—çµæœ
    let lastSimResults = null; 

    renderAll();

    // --- ğŸ”® æ¨¡æ“¬å™¨é‚è¼¯ ---
    function addSimStock() {
        let code = document.getElementById('sim-input-code').value.toUpperCase().trim();
        const amt = parseFloat(document.getElementById('sim-input-amt').value);
        if(!code || !amt) return alert("è«‹è¼¸å…¥ä»£è™ŸåŠé‡‘é¡");
        
        if (code.length > 0 && !code.includes('.')) {
            code += '.HK';
        }

        simStocks.push({ id: Date.now(), code, amt, manualPrice: '', manualCurrent: '', manualYield: '', useManual: false });
        renderSimList();
        
        const newStock = simStocks[simStocks.length - 1];
        fetchCurrentPriceForSim(newStock);

        document.getElementById('sim-input-code').value = '';
    }
    
    async function fetchCurrentPriceForSim(stock) {
        try {
            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${stock.code}?interval=1d&range=1d`;
            const res = await fetch(url);
            const data = await res.json();
            const price = data.chart.result[0].meta.regularMarketPrice;
            
            if(price) {
                stock.manualCurrent = price;
                const input = document.querySelector(`#manual-box-${stock.id} input[onchange*='current']`);
                if(input) {
                    input.value = price;
                    input.style.backgroundColor = '#ecfdf5';
                }
                const tag = document.getElementById(`sim-tag-${stock.id}`);
                if(tag) tag.innerHTML = `${stock.code} <small style='color:#666'>($${price})</small>`;
            }
        } catch(e) {
            console.log("Sim price fetch fail", e);
        }
    }

    function removeSimStock(id) {
        simStocks = simStocks.filter(s => s.id !== id);
        renderSimList();
    }

    function toggleManual(id) {
        const stock = simStocks.find(s => s.id === id);
        if(stock) {
            stock.useManual = !stock.useManual;
            renderSimList();
        }
    }

    function renderSimList() {
        const container = document.getElementById('sim-list-container');
        container.innerHTML = '';
        simStocks.forEach(s => {
            const div = document.createElement('div');
            div.className = 'sim-item';
            const manualStyle = s.useManual ? 'display:flex' : 'display:none';
            const btnText = s.useManual ? 'å–æ¶ˆæ‰‹å‹•' : 'æ‰‹å‹•/ä¿®æ­£';
            const priceDisplay = s.manualCurrent ? `<small style='color:#666'>($${s.manualCurrent})</small>` : '';

            div.innerHTML = `
                <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                    <div><span class="sim-tag" id="sim-tag-${s.id}">${s.code} ${priceDisplay}</span> <b style="margin-left:5px">$${s.amt}/æœˆ</b></div>
                    <div>
                        <button class="sim-manual-btn" onclick="toggleManual(${s.id})">${btnText}</button>
                        <button class="btn btn-sm btn-danger" style="margin-left:5px" onclick="removeSimStock(${s.id})">X</button>
                    </div>
                </div>
                <div class="sim-manual-box" id="manual-box-${s.id}" style="${manualStyle}">
                    <div style="flex:1; min-width:120px;">
                        <label class="small-text">æ¨¡æ“¬è²·å…¥åƒ¹</label>
                        <input type="number" value="${s.manualPrice}" onchange="updateSimManual(${s.id}, 'price', this.value)">
                    </div>
                    <div style="flex:1; min-width:120px;">
                        <label class="small-text">ç¾åƒ¹ (çµç®—ç”¨)</label>
                        <input type="number" value="${s.manualCurrent}" onchange="updateSimManual(${s.id}, 'current', this.value)">
                    </div>
                    <div style="flex:1; min-width:100px;">
                        <label class="small-text">å¹´æ¯%</label>
                        <input type="number" value="${s.manualYield}" onchange="updateSimManual(${s.id}, 'yield', this.value)">
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function updateSimManual(id, field, val) {
        const stock = simStocks.find(s => s.id === id);
        if(stock) {
            if(field === 'price') stock.manualPrice = val;
            if(field === 'current') stock.manualCurrent = val;
            if(field === 'yield') stock.manualYield = val;
        }
    }

    // ğŸ”¥ æ¨¡æ“¬å™¨æ ¸å¿ƒé‡æ§‹ï¼šè‚¡æ¯ä¿®å¾©ç‰ˆ + å®‰å…¨æª¢æŸ¥ ğŸ”¥
    async function runMultiSimulation() {
        if(simStocks.length === 0) return alert("è«‹å…ˆåŠ å…¥è‚¡ç¥¨");
        
        const btn = document.querySelector('.btn-sim[onclick="runMultiSimulation()"]');
        const startYear = parseInt(document.getElementById('sim-start-year').value);
        const startMonth = parseInt(document.getElementById('sim-start-month').value);
        const feePerStock = 50; 
        
        btn.textContent = "â³ è®€å–ä¸¦è¨ˆç®—ä¸­...";
        btn.disabled = true;

        let totalLabels = [];
        const startDate = new Date(startYear, startMonth - 1, 1);
        const startTs = Math.floor(startDate.getTime() / 1000);
        const endTs = Math.floor(Date.now() / 1000);
        
        const now = new Date();
        const monthsCount = (now.getFullYear() - startYear) * 12 + (now.getMonth() - (startMonth - 1));
        
        for(let m=0; m<=monthsCount; m++) {
            let d = new Date(startYear, startMonth - 1 + m, 1);
            totalLabels[m] = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
        }

        let calculatedStocks = [];

        try {
            for(let stock of simStocks) {
                let success = false;
                let costArr = new Array(totalLabels.length).fill(0);
                let assetArr = new Array(totalLabels.length).fill(0);
                let accumulatedDiv = 0; 
                let monthlyDetails = []; 

                if (!stock.useManual) {
                    try {
                        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${stock.code}?period1=${startTs}&period2=${endTs}&interval=1d&events=div`;
                        const res = await fetch(url);
                        if(res.ok) {
                            const data = await res.json();
                            const result = data.chart.result[0];
                            const meta = result.meta;
                            // å®‰å…¨æª¢æŸ¥ 1: ç¢ºä¿ quote å­˜åœ¨
                            const quoteData = result.indicators.quote[0];
                            const quotes = quoteData ? quoteData.close : [];
                            const timestamps = result.timestamp || [];
                            
                            // å®‰å…¨æª¢æŸ¥ 2: ç¢ºä¿ events å­˜åœ¨
                            // Yahoo æœ‰æ™‚è¿”å› null eventsï¼Œæˆ–æœ‰ events ä½†æ²’æœ‰ div
                            let rawEvents = {};
                            if (result.events && result.events.div) {
                                rawEvents = result.events.div;
                            }
                            
                            // å»ºç«‹è³‡æ–™æ¡¶ Map
                            let monthMap = {};
                            totalLabels.forEach(label => {
                                monthMap[label] = { priceSum: 0, count: 0, div: 0, lastPrice: 0 };
                            });

                            // 1. å¡«å…¥è‚¡åƒ¹
                            for(let i=0; i < timestamps.length; i++) {
                                const t = timestamps[i];
                                const price = quotes[i];
                                if(price === null || price === undefined) continue;

                                const dateObj = new Date(t * 1000);
                                const key = `${dateObj.getFullYear()}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}`;
                                if (monthMap[key]) {
                                    monthMap[key].priceSum += price;
                                    monthMap[key].count += 1;
                                    monthMap[key].lastPrice = price;
                                }
                            }

                            // 2. å¡«å…¥è‚¡æ¯
                            Object.keys(rawEvents).forEach(ts => {
                                const divData = rawEvents[ts];
                                const dateObj = new Date(ts * 1000);
                                const key = `${dateObj.getFullYear()}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}`;
                                if (monthMap[key]) {
                                    monthMap[key].div += divData.amount;
                                }
                            });

                            // 3. æ¨¡æ“¬è¨ˆç®—
                            if (quotes.length > 0) {
                                success = true;
                                let sShares = 0;
                                let sCost = 0;
                                const livePrice = meta.regularMarketPrice;

                                for(let i=0; i < totalLabels.length; i++) {
                                    const key = totalLabels[i];
                                    const mData = monthMap[key];
                                    
                                    let monthlyPrice = 0;
                                    if (i === totalLabels.length - 1 && livePrice) {
                                        monthlyPrice = livePrice;
                                    } else if (mData && mData.count > 0) {
                                        monthlyPrice = mData.priceSum / mData.count; 
                                    } else {
                                        for(let k=i-1; k>=0; k--) {
                                            if(monthMap[totalLabels[k]].count > 0) {
                                                monthlyPrice = monthMap[totalLabels[k]].lastPrice;
                                                break;
                                            }
                                        }
                                        if(monthlyPrice === 0 && livePrice) monthlyPrice = livePrice;
                                    }

                                    let sharesBought = 0;
                                    if (monthlyPrice > 0) {
                                        sCost += (stock.amt + feePerStock);
                                        sharesBought = (stock.amt / monthlyPrice);
                                        sShares += sharesBought;
                                    }

                                    let monthlyDivRec = 0;
                                    if (mData && mData.div > 0) {
                                        monthlyDivRec = (sShares * mData.div);
                                        accumulatedDiv += monthlyDivRec;
                                    }

                                    let currentPrice = monthlyPrice > 0 ? monthlyPrice : (mData ? mData.lastPrice : 0);
                                    let asset = (sShares * currentPrice) + accumulatedDiv;
                                    costArr[i] = sCost;
                                    assetArr[i] = asset;

                                    monthlyDetails.push({
                                        month: key,
                                        price: monthlyPrice,
                                        sharesBought: sharesBought,
                                        sharesTotal: sShares,
                                        divReceived: monthlyDivRec
                                    });
                                }
                            }
                        }
                    } catch(e) { console.log(stock.code + " fetch failed", e); }
                }

                if(!success) {
                    stock.useManual = true; 
                    renderSimList(); 
                    
                    const mBuyPrice = parseFloat(stock.manualPrice) || 0;
                    const mCurPrice = parseFloat(stock.manualCurrent) || mBuyPrice;
                    const mYield = parseFloat(stock.manualYield) || 0;
                    
                    if(mBuyPrice > 0) {
                        let totalShares = 0;
                        for(let i=0; i < totalLabels.length; i++) {
                            let monthlyCost = (stock.amt + feePerStock);
                            costArr[i] = (monthlyCost * (i+1)); 
                            
                            let sharesBought = stock.amt / mBuyPrice;
                            totalShares += sharesBought;

                            let progress = i / totalLabels.length;
                            let interpolatedPrice = mBuyPrice + (mCurPrice - mBuyPrice) * progress;
                            let marketValue = totalShares * interpolatedPrice;

                            let div = marketValue * (mYield/100) / 12;
                            accumulatedDiv += div;
                            assetArr[i] = (marketValue + accumulatedDiv);
                            
                            monthlyDetails.push({
                                month: totalLabels[i],
                                price: interpolatedPrice,
                                sharesBought: sharesBought,
                                sharesTotal: totalShares,
                                divReceived: div
                            });
                        }
                    }
                }

                calculatedStocks.push({
                    id: stock.id,
                    code: stock.code,
                    dataCost: costArr,
                    dataAsset: assetArr,
                    totalDiv: accumulatedDiv,
                    finalCost: costArr[costArr.length-1],
                    finalAsset: assetArr[assetArr.length-1],
                    details: monthlyDetails 
                });
            }

            lastSimResults = {
                labels: totalLabels,
                stocks: calculatedStocks
            };

            renderSimResultUI();
            updateSimAggregates();
            document.getElementById('sim-result-area').style.display = 'block';

        } catch(e) {
            console.error(e);
        } finally {
            btn.textContent = "ğŸš€ é–‹å§‹çµ„åˆæ¨¡æ“¬";
            btn.disabled = false;
        }
    }

    // ğŸ”¥ æ–°å¢ï¼šæ’åºåŠŸèƒ½é‚è¼¯ ğŸ”¥
    function sortSimResult(key) {
        if (simSort.key === key) {
            simSort.order = simSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            simSort.key = key;
            simSort.order = 'desc';
        }
        renderSimResultUI();
    }

    // ğŸ”¥ æ–°å¢ï¼šå±•é–‹/æ”¶èµ·æ˜ç´°é‚è¼¯ ğŸ”¥
    function toggleSimDetail(idx) {
        const row = document.getElementById(`sim-detail-row-${idx}`);
        if (row) {
            row.classList.toggle('expanded');
        }
    }

    function renderSimResultUI() {
        if (!lastSimResults) return;
        const tbody = document.getElementById('sim-detail-tbody');
        tbody.innerHTML = '';

        document.querySelectorAll('.sim-result-table th').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if(th.getAttribute('onclick') && th.getAttribute('onclick').includes(`'${simSort.key}'`)) {
                th.classList.add(simSort.order === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        });

        let displayList = lastSimResults.stocks.map((s, i) => ({...s, originalIndex: i}));

        displayList.sort((a, b) => {
            let valA, valB;
            switch(simSort.key) {
                case 'code': valA = a.code; valB = b.code; break;
                case 'cost': valA = a.finalCost; valB = b.finalCost; break;
                case 'value': valA = a.finalAsset - a.totalDiv; valB = b.finalAsset - b.totalDiv; break;
                case 'div': valA = a.totalDiv; valB = b.totalDiv; break;
                case 'net': valA = a.finalAsset - a.finalCost; valB = b.finalAsset - b.finalCost; break;
                default: valA = 0; valB = 0;
            }
            if(typeof valA === 'string') return simSort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            return simSort.order === 'asc' ? valA - valB : valB - valA;
        });

        displayList.forEach((s) => {
            const netReturn = s.finalAsset - s.finalCost;
            const netClass = netReturn >= 0 ? 'text-up' : 'text-down';
            const idx = s.originalIndex; 

            let detailsHtml = [...s.details].reverse().map(d => `
                <tr>
                    <td>${d.month}</td>
                    <td>$${d.price.toFixed(2)}</td>
                    <td>${d.sharesBought.toFixed(2)}</td>
                    <td class="${d.divReceived>0?'text-up':''}">${d.divReceived>0 ? '$'+d.divReceived.toFixed(2) : '-'}</td>
                </tr>
            `).join('');

            tbody.innerHTML += `
                <tr class="clickable-row" onclick="toggleSimDetail(${idx})">
                    <td class="text-center" onclick="event.stopPropagation()">
                        <input type="checkbox" class="sim-checkbox" checked 
                               data-idx="${idx}" onchange="updateSimAggregates()">
                    </td>
                    <td><b>${getStockName(s.code)}</b><br><span class="small-text">${s.code}</span></td>
                    <td class="text-right">$${fmtMoney(s.finalCost)}</td>
                    <td class="text-right">$${fmtMoney(s.finalAsset - s.totalDiv)}<br><span class="small-text">å¸‚å€¼</span></td>
                    <td class="text-right text-up">$${fmtMoney(s.totalDiv)}</td>
                    <td class="text-right ${netClass}">
                        ${netReturn>=0?'+':''}$${fmtMoney(netReturn)}
                    </td>
                </tr>
                <tr id="sim-detail-row-${idx}" class="sim-detail-row">
                    <td colspan="6" style="padding:0;">
                        <table class="sim-detail-inner-table">
                            <thead>
                                <tr>
                                    <th>æœˆä»½</th>
                                    <th>å¹³å‡è²·å…¥åƒ¹</th>
                                    <th>è²·å…¥è‚¡æ•¸</th>
                                    <th>æ”¶åˆ°è‚¡æ¯</th>
                                </tr>
                            </thead>
                            <tbody>${detailsHtml}</tbody>
                        </table>
                    </td>
                </tr>
            `;
        });
    }

    function updateSimAggregates() {
        if (!lastSimResults) return;

        const checkboxes = document.querySelectorAll('.sim-checkbox');
        const count = lastSimResults.labels.length;
        
        let totalCostArr = new Array(count).fill(0);
        let totalAssetArr = new Array(count).fill(0);
        let aggDiv = 0;

        let hasChecked = false;

        checkboxes.forEach(chk => {
            if (chk.checked) {
                hasChecked = true;
                const idx = parseInt(chk.getAttribute('data-idx'));
                const stockData = lastSimResults.stocks[idx]; 
                
                for (let i = 0; i < count; i++) {
                    totalCostArr[i] += stockData.dataCost[i];
                    totalAssetArr[i] += stockData.dataAsset[i];
                }
                aggDiv += stockData.totalDiv;
            }
        });

        if (!hasChecked) {
            totalCostArr.fill(0);
            totalAssetArr.fill(0);
        }

        const finalCost = totalCostArr[count-1];
        const finalVal = totalAssetArr[count-1];
        const retPct = finalCost > 0 ? ((finalVal - finalCost)/finalCost*100) : 0;

        document.getElementById('sim-res-cost').textContent = '$' + fmtMoney(finalCost);
        document.getElementById('sim-res-val').textContent = '$' + fmtMoney(finalVal);
        document.getElementById('sim-res-pct').textContent = (retPct>=0?'+':'') + retPct.toFixed(2) + '%';
        document.getElementById('sim-res-div').textContent = '$' + fmtMoney(aggDiv);

        if(simChartInst) simChartInst.destroy();
        simChartInst = new Chart(document.getElementById('simChart'), {
            type: 'line',
            data: {
                labels: lastSimResults.labels,
                datasets: [
                    { label: 'ç¸½ç´¯ç©æœ¬é‡‘', data: totalCostArr, borderColor: '#ccc', borderDash:[5,5], fill: false, pointRadius:0 },
                    { label: 'ç¸½è³‡ç”¢ä¼°å€¼', data: totalAssetArr, borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', fill: true, pointRadius:0 }
                ]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { 
                    datalabels: { display: false },
                    title: { display: true, text: 'çµ„åˆè³‡ç”¢å¢é•·æ¨¡æ“¬ (å·²é¸é …ç›®)' }
                },
                interaction: { mode: 'index', intersect: false }
            }
        });
    }

    // --- æ ¸å¿ƒè¨ˆç®—å¼•æ“ ---
    function getPortfolioAnalysis() {
        let p = {};
        let sortedTrans = [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date));
        sortedTrans.forEach(t => {
            if (!p[t.code]) {
                p[t.code] = { qty: 0, currentCost: 0, totalInvested: 0, totalDiv: 0, soldCash: 0, soldCost: 0, sellFees: 0, grossSold: 0 };
            }
            let stock = p[t.code];
            if (t.type === 'buy') {
                stock.qty += t.qty; stock.currentCost += t.total; stock.totalInvested += t.total;
            } else if (t.type === 'sell') {
                let avgCost = stock.qty > 0 ? (stock.currentCost / stock.qty) : 0;
                let costOfSoldPart = avgCost * t.qty;
                let fee = t.fee || 0; let gross = t.total + fee;
                stock.qty -= t.qty; stock.currentCost -= costOfSoldPart; stock.soldCost += costOfSoldPart; stock.soldCash += t.total; stock.sellFees += fee; stock.grossSold += gross;
                if(stock.qty <= 0.0001) { stock.qty = 0; stock.currentCost = 0; }
            } else if (t.type === 'dividend_cash' || t.type === 'dividend') {
                stock.totalDiv += t.total;
            } else if (t.type === 'dividend_scrip') {
                stock.qty += t.qty;
            }
        });
        return p;
    }

    // --- æ ¼å¼åŒ–å·¥å…· ---
    function fmtMoney(num) {
        return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // --- æ¸²æŸ“ UI ---
    function renderAll() {
        const portfolio = getPortfolioAnalysis();
        renderKPI(portfolio);
        renderPortfolioTable(portfolio);
        renderROITable(portfolio);
        renderHistory();
        renderCharts(portfolio);
    }

    // 1. æ¸²æŸ“ KPI
    function renderKPI(p) {
        let totalCost = 0; let totalMarket = 0; let totalDiv = 0; let totalSoldCash = 0; let totalInvestedAllTime = 0; let totalSellFees = 0; 
        for (let c in p) {
            const s = p[c]; const price = priceCache[c] || 0;
            totalCost += s.currentCost; totalMarket += (s.qty * price); totalDiv += s.totalDiv; totalSoldCash += s.soldCash; totalInvestedAllTime += s.totalInvested; totalSellFees += s.sellFees;
        }
        const adjustedTotalInvested = totalInvestedAllTime + totalSellFees;
        const totalReturn = (totalMarket + totalDiv + totalSoldCash) - totalInvestedAllTime;
        const retPct = adjustedTotalInvested > 0 ? (totalReturn / adjustedTotalInvested * 100) : 0;

        document.getElementById('kpi-cost').textContent = '$' + fmtMoney(adjustedTotalInvested);
        document.getElementById('kpi-market').textContent = '$' + fmtMoney(totalMarket);
        document.getElementById('kpi-div').textContent = '$' + fmtMoney(totalDiv);
        const pnlEl = document.getElementById('kpi-pnl');
        pnlEl.textContent = (totalReturn>=0?'+':'') + '$' + fmtMoney(totalReturn);
        const pctEl = document.getElementById('kpi-pnl-pct');
        pctEl.textContent = (retPct>=0?'+':'') + retPct.toFixed(2) + '%';
        pctEl.className = retPct >= 0 ? 'small-text text-up kpi-sub' : 'small-text text-down kpi-sub';
    }

    // 2. æ¸²æŸ“æŒå€‰è¡¨æ ¼
    function sortPortfolio(key) {
        if (portfolioSort.key === key) { portfolioSort.order = portfolioSort.order === 'asc' ? 'desc' : 'asc'; } else { portfolioSort.key = key; portfolioSort.order = 'desc'; }
        renderPortfolioTable(getPortfolioAnalysis());
    }
    function renderPortfolioTable(p) {
        const tbody = document.querySelector('#portfolio-table tbody'); tbody.innerHTML = '';
        let rows = [];
        for (let c in p) {
            const s = p[c]; if (s.qty <= 0.01) continue;
            const price = priceCache[c] || 0; const marketVal = s.qty * price; const avgPrice = s.qty > 0 ? (s.currentCost / s.qty) : 0; const paperPnl = marketVal - s.currentCost;
            rows.push({ code: c, name: getStockName(c), qty: s.qty, avgPrice: avgPrice, price: price, marketVal: marketVal, paperPnl: paperPnl, data: s });
        }
        rows.sort((a, b) => {
            let valA = a[portfolioSort.key]; let valB = b[portfolioSort.key];
            if (typeof valA === 'string') return portfolioSort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            return portfolioSort.order === 'asc' ? valA - valB : valB - valA;
        });
        rows.forEach(r => {
            const rowId = `row-${r.code.replace('.','-')}`;
            tbody.innerHTML += `
                <tr class="clickable-row" onclick="toggleDetail('${rowId}', this)">
                    <td data-label="è‚¡ç¥¨"><div><b>${r.name}</b> <span class="small-text">${r.code}</span></div></td>
                    <td data-label="æŒå€‰è‚¡æ•¸" class="mobile-hidden text-right">${r.qty.toFixed(0)}</td>
                    <td data-label="å¹³å‡è²·å…¥åƒ¹" class="mobile-hidden text-right">$${fmtMoney(r.avgPrice)}</td>
                    <td data-label="ç¾åƒ¹ (è¼¸å…¥)" class="mobile-hidden text-right" style="background:var(--primary-light);">
                        <input type="number" value="${r.price}" placeholder="ç¾åƒ¹" onclick="event.stopPropagation()" onchange="updatePrice('${r.code}', this.value)" style="text-align:right;">
                    </td>
                    <td data-label="å¸‚å€¼" class="text-right">$${fmtMoney(r.marketVal)}</td>
                    <td data-label="å¸³é¢ç›ˆè™§" class="text-right ${r.paperPnl>=0?'text-up':'text-down'}">${r.paperPnl>=0?'+':''}${fmtMoney(r.paperPnl)}</td>
                </tr>
                <tr id="${rowId}" class="detail-row">
                    <td colspan="6">
                        <div class="detail-content">
                            <div class="detail-item"><strong>æŒå€‰æˆæœ¬</strong> $${fmtMoney(r.data.currentCost)}</div>
                            <div class="detail-item"><strong>æ­·å²ç¸½è‚¡æ¯</strong> $${fmtMoney(r.data.totalDiv)}</div>
                            <div class="detail-item"><strong>å·²è®Šç¾é‡‘é¡</strong> $${fmtMoney(r.data.soldCash)}</div>
                            <div class="detail-item"><strong>æ­·å²ç¸½æŠ•å…¥</strong> $${fmtMoney(r.data.totalInvested)}</div>
                            <div class="detail-item"><strong>å·²å¹³å€‰æç›Š</strong> <span class="${(r.data.soldCash - r.data.soldCost)>=0?'text-up':'text-down'}">$${fmtMoney(r.data.soldCash - r.data.soldCost)}</span></div>
                            <div class="detail-item"><strong>è³£å‡ºæ‰‹çºŒè²»</strong> $${fmtMoney(r.data.sellFees)}</div>
                        </div>
                    </td>
                </tr>
            `;
        });
        updateSortIcons('portfolio-table', portfolioSort);
    }
    function toggleDetail(rowId, mainRow) {
        const row = document.getElementById(rowId);
        if(row.style.display === 'none' || row.style.display === '') {
            const isMobile = window.innerWidth <= 768; row.style.display = isMobile ? 'block' : 'table-row'; mainRow.classList.add('expanded');
        } else { row.style.display = 'none'; mainRow.classList.remove('expanded'); }
    }

    // 3. æ¸²æŸ“ ROI æ’è¡Œæ¦œ
    function sortRoi(key) {
        if (roiSort.key === key) { roiSort.order = roiSort.order === 'asc' ? 'desc' : 'asc'; } else { roiSort.key = key; roiSort.order = 'desc'; }
        renderROITable(getPortfolioAnalysis());
    }
    function renderROITable(p) {
        const tbody = document.querySelector('#roi-table tbody'); tbody.innerHTML = '';
        let rows = [];
        for (let c in p) {
            const s = p[c]; if (s.totalInvested === 0 && s.qty === 0 && s.totalDiv === 0) continue;
            const price = priceCache[c] || 0; const marketVal = s.qty * price; const realizedPnl = s.soldCash - s.soldCost;
            const totalProfit = (marketVal + s.totalDiv + s.soldCash) - s.totalInvested; const adjustedInv = s.totalInvested; 
            const yieldRate = adjustedInv > 0 ? (s.totalDiv / adjustedInv) * 100 : 0; const totalRetPct = adjustedInv > 0 ? (totalProfit / adjustedInv) * 100 : 0;
            rows.push({ code: c, name: getStockName(c), totalInvested: adjustedInv, totalDiv: s.totalDiv, realizedPnl: realizedPnl, yield: yieldRate, totalRetPct: totalRetPct, totalProfit: totalProfit });
        }
        rows.sort((a, b) => {
            let valA = a[roiSort.key]; let valB = b[roiSort.key];
            if (typeof valA === 'string') return roiSort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            return roiSort.order === 'asc' ? valA - valB : valB - valA;
        });
        rows.forEach((r, idx) => {
            let badge = ''; if (roiSort.key === 'totalRetPct' && roiSort.order === 'desc') { if (idx === 0) badge = '<span class="badge bg-gold">1</span> '; if (idx === 1) badge = '<span class="badge bg-gray">2</span> '; if (idx === 2) badge = '<span class="badge bg-bronze">3</span> '; }
            tbody.innerHTML += `
                <tr class="clickable-row" onclick="this.classList.toggle('expanded')">
                    <td data-label="è‚¡ç¥¨"><div>${badge}<b>${r.name}</b> <span class="small-text">${r.code}</span></div></td>
                    <td data-label="ç¸½æŠ•å…¥æˆæœ¬" class="mobile-hidden text-right">$${fmtMoney(r.totalInvested)}</td>
                    <td data-label="ç¸½è‚¡æ¯" class="mobile-hidden text-right">$${fmtMoney(r.totalDiv)}</td>
                    <td data-label="è‚¡æ¯ç‡" class="text-up mobile-hidden text-right">${r.yield.toFixed(2)}%</td>
                    <td data-label="å·²å¹³å€‰æç›Š" class="mobile-hidden text-right ${r.realizedPnl>=0?'text-up':'text-down'}">${r.realizedPnl>=0?'+':''}${fmtMoney(r.realizedPnl)}</td>
                    <td data-label="ç¸½å›å ± ($)" class="mobile-hidden text-right ${r.totalProfit>=0?'text-up':'text-down'}"><b>${r.totalProfit>=0?'+':''}${fmtMoney(r.totalProfit)}</b></td>
                    <td data-label="ç¸½å›å ±ç‡ (%)" class="text-right ${r.totalRetPct>=0?'text-up':'text-down'}"><b>${r.totalRetPct>=0?'+':''}${r.totalRetPct.toFixed(2)}%</b></td>
                </tr>
            `;
        });
        updateSortIcons('roi-table', roiSort);
    }
    function updateSortIcons(tableId, sortState) {
        document.querySelectorAll(`#${tableId} th`).forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.getAttribute('onclick') && th.getAttribute('onclick').includes(`'${sortState.key}'`)) { th.classList.add(sortState.order === 'asc' ? 'sort-asc' : 'sort-desc'); }
        });
    }

    // --- åœ–è¡¨åŠŸèƒ½ ---
    function renderCharts(p) {
        const dates = [...new Set(transactions.map(t => t.date.substring(0,7)))].sort();
        let accRealizedPnl = 0, accDiv = 0, accHoldingCost = 0; 
        let dataRealized = [], dataDiv = [], dataHoldingCost = [], dataMarketLine = [];
        let currentTotalMarket = 0;
        for (let c in p) { if(p[c].qty > 0) currentTotalMarket += (p[c].qty * (priceCache[c]||0)); }
        let sorted = [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date));
        let monthly = {}, tempStock = {}; 

        sorted.forEach(t => {
            let m = t.date.substring(0,7);
            if(!tempStock[t.code]) tempStock[t.code] = { qty:0, cost:0 };
            let ts = tempStock[t.code];
            if(t.type === 'buy') { ts.qty += t.qty; ts.cost += t.total; accHoldingCost += t.total; }
            else if(t.type === 'dividend_cash') { accDiv += t.total; }
            else if(t.type === 'dividend_scrip') { ts.qty += t.qty; }
            else if(t.type === 'sell') {
                let avg = ts.qty > 0 ? ts.cost / ts.qty : 0; let costPart = avg * t.qty; let pnl = t.total - costPart; accRealizedPnl += pnl;
                ts.qty -= t.qty; ts.cost -= costPart; accHoldingCost -= costPart;
                if(ts.qty <= 0.0001) { ts.qty = 0; ts.cost = 0; }
            }
            monthly[m] = { realized: accRealizedPnl, div: accDiv, holding: accHoldingCost };
        });

        dates.forEach(m => {
            let lastR = dataRealized.length ? dataRealized[dataRealized.length-1] : 0;
            let lastD = dataDiv.length ? dataDiv[dataDiv.length-1] : 0;
            let lastH = dataHoldingCost.length ? dataHoldingCost[dataHoldingCost.length-1] : 0;
            if(monthly[m]) { dataRealized.push(monthly[m].realized); dataDiv.push(monthly[m].div); dataHoldingCost.push(monthly[m].holding); } 
            else { dataRealized.push(lastR); dataDiv.push(lastD); dataHoldingCost.push(lastH); }
            dataMarketLine.push(currentTotalMarket);
        });

        if(trendChartInst1) trendChartInst1.destroy();
        trendChartInst1 = new Chart(document.getElementById('trendChart1'), {
            type: 'line',
            data: { labels: dates, datasets: [{ label: 'ç´¯ç©è‚¡æ¯æ”¶å…¥', data: dataDiv, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true }] },
            options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'ç´¯ç©è‚¡æ¯æ”¶å…¥è¶¨å‹¢' }, datalabels: { display: false } } }
        });

        if(trendChartInst2) trendChartInst2.destroy();
        trendChartInst2 = new Chart(document.getElementById('trendChart2'), {
            type: 'line',
            data: { labels: dates, datasets: [{ label: 'ç´¯ç©æŒå€‰æˆæœ¬', data: dataHoldingCost, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true }, { label: 'ç¾æœ‰æŒå€‰åƒ¹å€¼ (åƒè€ƒç·š)', data: dataMarketLine, borderColor: '#ef4444', borderDash: [5, 5], fill: false, pointRadius: 0 }] },
            options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'æˆæœ¬è¦æ¨¡ vs ç•¶å‰å¸‚å€¼' }, datalabels: { display: false } } }
        });

        if(pieChartInst) pieChartInst.destroy();
        let labels = [], data = [], totalVal = 0;
        for(let c in p) { if(p[c].qty>0) { let v = p[c].qty * (priceCache[c]||0); totalVal += v; } }
        for(let c in p) { if(p[c].qty>0) { let v = p[c].qty * (priceCache[c]||0); labels.push(getStockName(c).replace(/[0-9.]/g,'').substring(0,6) || c); data.push(v); } }
        pieChartInst = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: ['#2563eb','#0ea5e9','#10b981','#f59e0b','#ef4444','#8b5cf6','#db2777','#f97316'] }] },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' }, datalabels: { display: true, color: '#fff', font: { weight: 'bold' }, formatter: (value) => totalVal > 0 ? (value*100 / totalVal).toFixed(1)+"%" : "0%" } } }
        });

        if(barChartInst) barChartInst.destroy();
        let yearly = {};
        sorted.forEach(t => { if(t.type.includes('dividend') && !t.type.includes('scrip')) { let y = t.date.substring(0,4); yearly[y] = (yearly[y]||0) + t.total; } });
        barChartInst = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: Object.keys(yearly), datasets: [{ label: 'å¹´åº¦è‚¡æ¯æ”¶å…¥', data: Object.values(yearly), backgroundColor: '#0ea5e9' }] },
            options: { maintainAspectRatio: false, plugins: { datalabels: { display: false } } }
        });
    }

    // --- äº¤æ˜“è¨˜éŒ„ ---
    function renderHistory() {
        const tbody = document.querySelector('#history-table tbody');
        tbody.innerHTML = '';
        const list = [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date));
        let currentMonth = '';
        list.forEach(t => {
            const m = t.date.substring(0, 7);
            if (m !== currentMonth) {
                currentMonth = m;
                tbody.innerHTML += `<tr class="history-month-row"><td colspan="8">${m.replace('-', 'å¹´')}æœˆ</td></tr>`;
            }
            let act = '', valClass = '', actionIcon = '';
            if(t.type==='buy') { act='è²·å…¥'; valClass='text-down'; actionIcon='ğŸ“¥'; }
            else if(t.type==='sell') { act='è³£å‡º'; valClass='text-up'; actionIcon='ğŸ“¤'; }
            else if(t.type.includes('cash')) { act='æ”¶æ¯(éŒ¢)'; valClass='text-up'; actionIcon='ğŸ’°'; }
            else if(t.type.includes('scrip')) { act='æ”¶æ¯(è²¨)'; valClass='text-up'; actionIcon='ğŸ'; }
            let priceStr = t.price ? `$${fmtMoney(t.price)}` : '-';
            let qtyStr = t.qty ? t.qty : '-';
            let feeStr = t.fee ? `$${fmtMoney(t.fee)}` : '-';
            let totalStr = '';
            if (t.type === 'buy') totalStr = `-$${fmtMoney(t.total)}`;
            else if (t.type === 'dividend_scrip') totalStr = `+${t.qty}è‚¡`;
            else totalStr = `+$${fmtMoney(t.total)}`;
            
            tbody.innerHTML += `
                <tr class="history-item-row" onclick="this.classList.toggle('expanded')">
                    <td data-label="æ—¥æœŸ">
                        <div class="history-primary-info">
                            <span>${t.date.slice(5)} ${actionIcon} ${act}</span>
                            <span class="${valClass}">${totalStr}</span>
                        </div>
                    </td>
                    <td data-label="ä»£è™Ÿ"><div><b>${getStockName(t.code)}</b> <span class="small-text">${t.code}</span></div></td>
                    <td class="desktop-only">${act}</td> 
                    <td data-label="å–®åƒ¹" class="mobile-hidden text-right">${priceStr}</td>
                    <td data-label="è‚¡æ•¸" class="mobile-hidden text-right">${qtyStr}</td>
                    <td data-label="æ‰‹çºŒè²»" class="mobile-hidden small-text text-right">${feeStr}</td>
                    <td class="desktop-only ${valClass} text-right" style="font-weight:bold">${totalStr}</td>
                    <td data-label="æ“ä½œ"><button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); delTrans(${t.id})">åˆªé™¤</button></td>
                </tr>
            `;
        });
    }

    // --- è¼”åŠ©åŠŸèƒ½ ---
    function addBatchRow(code='', qty='', type='buy') {
        const tbody = document.getElementById('batch-body');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <select class="row-type" onchange="handleTypeChange(this)">
                    <option value="buy" ${type==='buy'?'selected':''}>è²·å…¥</option>
                    <option value="dividend_cash">æ”¶æ¯ (æ´¾éŒ¢)</option>
                    <option value="dividend_scrip">æ”¶æ¯ (æ´¾è²¨)</option>
                    <option value="sell">è³£å‡º</option>
                </select>
            </td>
            <td><input type="text" class="row-code" value="${code}" placeholder="0005.HK" oninput="this.value=this.value.toUpperCase()"></td>
            <td><input type="number" class="row-price" step="0.01" placeholder="å–®åƒ¹"></td>
            <td><input type="number" class="row-qty" value="${qty}" placeholder="è‚¡æ•¸"></td>
            <td><button class="btn btn-danger" style="padding:5px;" onclick="this.closest('tr').remove()">X</button></td>
        `;
        tbody.appendChild(tr);
        handleTypeChange(tr.querySelector('.row-type'));
    }

    function handleTypeChange(select) {
        const tr = select.closest('tr');
        const priceInp = tr.querySelector('.row-price');
        const qtyInp = tr.querySelector('.row-qty');
        const type = select.value;
        priceInp.disabled = false; qtyInp.disabled = false;
        priceInp.value = ''; qtyInp.value = '';
        if(type === 'dividend_cash') {
            priceInp.placeholder = "ç¸½é‡‘é¡ ($)"; qtyInp.disabled = true; qtyInp.placeholder = "-";
        } else if(type === 'dividend_scrip') {
            priceInp.disabled = true; priceInp.placeholder = "0"; qtyInp.placeholder = "æ”¶åˆ°è‚¡æ•¸";
        } else {
            priceInp.placeholder = "å–®åƒ¹"; qtyInp.placeholder = "è‚¡æ•¸";
        }
    }

    function saveBatchTransaction() {
        const date = document.getElementById('batch-date').value;
        const globalFee = parseFloat(document.getElementById('batch-fee').value) || 0;
        const rows = document.querySelectorAll('#batch-body tr');
        let newTrans = [];
        let totalBuyVal = 0;
        let template = [];
        rows.forEach(tr => {
            const type = tr.querySelector('.row-type').value;
            let code = tr.querySelector('.row-code').value.trim();
            const val1 = parseFloat(tr.querySelector('.row-price').value) || 0;
            const val2 = parseFloat(tr.querySelector('.row-qty').value) || 0;
            if(!code) return;
            if(!code.includes('.')) code += '.HK';
            let t = { id: Date.now()+Math.random(), date, type, code, price:0, qty:0, total:0, fee:0 };
            if(type === 'buy') {
                t.price = val1; t.qty = val2; t.total = val1*val2; totalBuyVal += t.total; template.push({code, qty: val2});
            } else if(type === 'sell') {
                t.price = val1; t.qty = val2; t.total = val1*val2; 
            } else if(type === 'dividend_cash') {
                t.total = val1;
            } else if(type === 'dividend_scrip') {
                t.qty = val2;
            }
            newTrans.push(t);
        });
        if(newTrans.length === 0) return;
        newTrans.forEach(t => {
            if(t.type === 'buy' && totalBuyVal > 0) { t.fee = globalFee * (t.total / totalBuyVal); t.total += t.fee; }
            if(t.type === 'sell') { 
                if(t.price > 0 && globalFee > 0) {
                     t.fee = globalFee; 
                     t.total -= t.fee;
                }
            }
        });
        transactions = transactions.concat(newTrans);
        transactions.sort((a,b) => new Date(a.date) - new Date(b.date));
        saveAndRefresh();
        if(template.length>0) localStorage.setItem('stock_v4_template', JSON.stringify(template));
        document.getElementById('batch-body').innerHTML = '';
        if(template.length>0) template.forEach(x => addBatchRow(x.code, x.qty)); else addBatchRow();
        alert("å·²å„²å­˜è¨˜éŒ„ï¼");
    }

    function saveAndRefresh() { 
        localStorage.setItem('stock_v4_trans', JSON.stringify(transactions)); 
        renderAll(); 
    }
    function updatePrice(code, val) {
        priceCache[code] = parseFloat(val);
        localStorage.setItem('stock_v4_prices', JSON.stringify(priceCache));
        renderAll();
    }
    async function fetchYahooPrices() {
        const p = getPortfolioAnalysis();
        const codes = Object.keys(p).filter(c => p[c].qty > 0);
        if (codes.length === 0) return alert("ç›®å‰æ²’æœ‰æŒå€‰éœ€è¦æ›´æ–°");
        
        const btn = document.querySelector('.btn-success[onclick="fetchYahooPrices()"]');
        const originalText = btn.textContent;
        btn.textContent = "â³ æ›´æ–°ä¸­...";
        btn.disabled = true;

        let updated = 0;
        for (let code of codes) {
            try {
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${code}?interval=1d&range=1d`;
                const res = await fetch(yahooUrl);
                const data = await res.json();
                const price = data.chart.result[0].meta.regularMarketPrice;
                if(price) { priceCache[code] = price; updated++; }
            } catch(e) { console.error(code, e); }
        }
        localStorage.setItem('stock_v4_prices', JSON.stringify(priceCache));
        renderAll();
        
        btn.textContent = originalText;
        btn.disabled = false;
        alert(`å·²æ›´æ–° ${updated} éš»è‚¡ç¥¨åƒ¹æ ¼`);
    }

    function importBuyData() {
        const raw = document.getElementById('excel-buy-area').value;
        if(!raw) return;
        const lines = raw.split('\n').map(l => l.split('\t'));
        const header = lines[0];
        let newItems = [];
        let stockCols = [];
        for(let col=0; col < header.length; col++) {
            let code = header[col] ? header[col].trim() : '';
            if(code && (code.includes('.') || !isNaN(code)) && code !== 'æ—¥æœŸ' && code !== 'æ‰‹çºŒè²»') {
                 if(!code.includes('.')) code += ".HK";
                 stockCols.push({ index: col, code: code });
            }
        }
        for(let i=1; i<lines.length; i++) {
            const r = lines[i];
            if(!r[0] || r[0].includes('å¹´')) continue;
            const date = r[0].trim().replace(/\//g, '-');
            const rowTotalFee = parseFloat(r[1]) || 0;
            let rowBuys = [];
            let rowBuyValue = 0;
            stockCols.forEach(sc => {
                const qty = parseFloat(r[sc.index]) || 0;
                let priceRaw = r[sc.index+1];
                if (typeof priceRaw === 'string') priceRaw = priceRaw.trim();
                const price = parseFloat(priceRaw) || 0;
                const div = parseFloat(r[sc.index+3]) || 0;
                if(qty > 0) {
                    if (price > 0) {
                        rowBuys.push({ code: sc.code, qty, price, rawTotal: qty*price });
                        rowBuyValue += (qty*price);
                    } else {
                         newItems.push({ id: Math.random(), date, type: 'dividend_scrip', code: sc.code, qty: qty, price: 0, total: 0, fee: 0 });
                    }
                }
                if(div > 0) newItems.push({ id: Math.random(), date, type: 'dividend_cash', code: sc.code, qty: 0, price: 0, total: div, fee: 0 });
            });
            rowBuys.forEach(b => {
                let allocatedFee = 0;
                if(rowBuyValue > 0) allocatedFee = rowTotalFee * (b.rawTotal / rowBuyValue);
                newItems.push({ id: Math.random(), date, type: 'buy', code: b.code, qty: b.qty, price: b.price, total: b.rawTotal + allocatedFee, fee: allocatedFee });
            });
        }
        transactions = [...transactions, ...newItems].sort((a,b)=>new Date(a.date)-new Date(b.date));
        saveAndRefresh();
        alert(`åŒ¯å…¥æˆåŠŸï¼å·²åŠ å…¥ ${newItems.length} ç­†è¨˜éŒ„ã€‚`);
        document.getElementById('excel-buy-area').value = '';
    }

    function importSellData() {
        const raw = document.getElementById('excel-sell-area').value;
        if(!raw) return;
        const lines = raw.split('\n').map(l => l.split('\t'));
        let newSells = [];
        for (let col = 0; col < lines[0].length; col += 4) {
            let code = lines[0][col] ? lines[0][col].trim() : "";
            if (!code || isNaN(code)) continue;
            if (!code.includes('.')) code += ".HK";
            for (let i = 2; i < lines.length; i++) {
                const r = lines[i];
                const date = r[col] ? r[col].trim().replace(/\//g, '-') : "";
                if (!date || date === "æ—¥æœŸ") continue;
                const fee = Math.abs(parseFloat(r[col+1])) || 0;
                const qty = Math.abs(parseFloat(r[col+2])) || 0;
                const price = parseFloat(r[col+3]) || 0;
                if (qty > 0 && price > 0) {
                    newSells.push({ id: Math.random(), date, type: 'sell', code, qty, price, total: (qty * price) - fee, fee });
                }
            }
        }
        transactions = [...transactions, ...newSells].sort((a,b)=>new Date(a.date)-new Date(b.date));
        saveAndRefresh();
        alert(`æˆåŠŸåŒ¯å…¥ ${newSells.length} ç­†è³£å‡ºè¨˜éŒ„`);
        document.getElementById('excel-sell-area').value = '';
    }

    function delTrans(id) {
        if(confirm("åˆªé™¤æ­¤è¨˜éŒ„ï¼Ÿ")) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('stock_v4_trans', JSON.stringify(transactions));
            renderAll();
        }
    }
    function clearAllData() {
        if(confirm("âš ï¸ ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿç„¡æ³•å¾©åŸï¼")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
