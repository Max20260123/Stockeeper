<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stockeeper v1.3</title>
    <!-- Chart.js æ ¸å¿ƒ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Chart.js æ•¸æ“šæ¨™ç±¤æ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        :root {
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --primary: #1890ff;
            --success: #52c41a;
            --danger: #f5222d;
            --warning: #faad14;
            --text: #333;
            --border: #e8e8e8;
            --hover: #f5f5f5;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card { background: var(--card-bg); padding: 24px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); overflow: hidden; /* é˜²æ­¢è¡¨æ ¼æº¢å‡ºåœ“è§’ */ }
        h2, h3 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 12px; font-size: 1.1rem; color: #1f1f1f; display: flex; justify-content: space-between; align-items: center; }
        
        /* é¡è‰²å·¥å…· */
        .text-up { color: var(--success); font-weight: bold; }
        .text-down { color: var(--danger); font-weight: bold; }
        .text-neutral { color: #666; }
        .small-text { font-size: 0.85rem; color: #8c8c8c; font-weight: normal; }
        
        /* KPI å„€è¡¨æ¿ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .kpi-box { background: #fafafa; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid var(--border); }
        .kpi-title { font-size: 0.9rem; color: #666; margin-bottom: 8px; }
        .kpi-val { font-size: 1.4rem; font-weight: bold; color: #000; }

        /* è¡¨æ ¼æ¨£å¼ (é›»è…¦ç‰ˆé è¨­) */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; table-layout: fixed; }
        th { text-align: left; padding: 12px 8px; background: #fafafa; border-bottom: 2px solid var(--border); cursor: pointer; user-select: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        th:hover { background: #e6f7ff; }
        td { padding: 10px 8px; border-bottom: 1px solid var(--border); vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        
        /* å¯å±•é–‹çš„è©³ç´°è¡Œ */
        .clickable-row { cursor: pointer; transition: 0.2s; }
        .clickable-row:hover { background: var(--hover); }
        .detail-row { background-color: #f9f9f9; display: none; }
        .detail-content { padding: 15px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.85rem; color: #555; }
        .detail-item strong { display: block; color: #333; margin-bottom: 3px; }

        /* æ­·å²è¨˜éŒ„å°ˆç”¨æ¨£å¼ */
        #history-table { font-size: 0.85rem; }
        #history-table td, #history-table th { padding: 6px 8px; }
        .history-month-row { background: #e6f7ff; color: var(--primary); font-weight: bold; font-size: 0.9rem; border-top: 2px solid #bae7ff; }
        
        /* æ’åºåœ–ç¤º */
        .sort-icon::after { content: ' â†•'; font-size: 0.8em; color: #ccc; }
        .sort-asc::after { content: ' â†‘'; color: var(--primary); }
        .sort-desc::after { content: ' â†“'; color: var(--primary); }

        /* è¼¸å…¥æ§ä»¶ */
        input, select, textarea { padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; width: 100%; box-sizing: border-box; transition: 0.3s; -webkit-appearance: none; }
        input:focus { border-color: var(--primary); outline: none; }
        input:disabled { background: #f5f5f5; cursor: not-allowed; }

        /* æŒ‰éˆ• */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid #d9d9d9; color: #666; }
        .btn-sm { padding: 2px 6px; font-size: 0.75rem; }
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }

        /* å¾½ç«  */
        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; color: white; font-weight: bold; }
        .bg-gold { background: #faad14; }
        .bg-gray { background: #bfbfbf; }
        .bg-bronze { background: #d48806; }
        
        .import-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* --- ğŸ“± ç§»å‹•ç«¯å°ˆå±¬å„ªåŒ– (iPhone/Android) --- */
        @media (max-width: 768px) {
            body { padding: 10px 0px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); background: #fff; } /* Body èƒŒæ™¯æ”¹ç™½ï¼Œæ¸›å°‘é‚Šè·æ„Ÿ */
            .container { gap: 10px; width: 100%; max-width: 100%; overflow-x: hidden; }
            
            /* å¡ç‰‡èª¿æ•´ */
            .card { 
                padding: 15px; 
                border-radius: 0; /* ç§»é™¤åœ“è§’è®“å®ƒçœ‹èµ·ä¾†æ›´åƒåŸç”Ÿ App */
                box-shadow: none; 
                border-bottom: 10px solid var(--bg); /* ç”¨åº•éƒ¨é‚Šæ¡†æ¨¡æ“¬å¡ç‰‡é–“è· */
            }
            .card:last-child { border-bottom: none; }
            
            h3 { font-size: 1rem; }
            input, select, textarea { font-size: 16px !important; }

            .dashboard-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .kpi-box { padding: 10px 5px; }
            .kpi-val { font-size: 1.1rem; }
            .kpi-title { font-size: 0.8rem; }

            .grid-charts { grid-template-columns: 1fr !important; display: block !important; }
            .grid-charts > div { height: 250px !important; margin-bottom: 20px; }
            .import-grid { grid-template-columns: 1fr !important; }
            .btn-row { flex-direction: column; }
            .btn { width: 100%; padding: 12px; font-size: 1rem; }
            .btn-sm { width: auto; padding: 4px 8px; }
            .detail-content { grid-template-columns: 1fr !important; gap: 8px; }
            
            /* æ–°å¢äº¤æ˜“è¡¨æ ¼å¾®èª¿ */
            #batch-input-table th, #batch-input-table td { padding: 5px 2px; font-size: 0.8rem; }
            #batch-input-table input, #batch-input-table select { padding: 8px 4px; }
            
            /* --- ğŸ“‡ å¡ç‰‡å¼è¡¨æ ¼å„ªåŒ– v3 (å…¨å±é—Šåº¦ & éš±è—å„ªåŒ–) --- */
            
            /* å…¨å±é—Šåº¦å®¹å™¨ä¿®æ­£ (Full Bleed) */
            /* é‡å°æ‰‹æ©Ÿç‰ˆï¼Œå¼·åˆ¶è¡¨æ ¼å®¹å™¨å‘å·¦å³å»¶ä¼¸ä»¥æŠµæ¶ˆ Card Padding */
            .full-bleed-mobile {
                margin-left: -15px;
                margin-right: -15px;
                width: calc(100% + 30px);
                border-top: 1px solid #eee;
            }

            .mobile-card-table { display: block; width: 100%; }
            .mobile-card-table thead { display: none; }
            
            /* æ¯ä¸€è¡Œè®Šæˆä¸€å¼µå¡ç‰‡ */
            .mobile-card-table tbody tr.clickable-row, 
            .mobile-card-table tbody tr.history-item-row {
                display: block;
                background: #fff;
                border-bottom: 1px solid #f0f0f0;
                padding: 12px 15px; /* å¢åŠ å…§è·ï¼Œå› ç‚ºæˆ‘å€‘æ‹‰å¯¬äº†å®¹å™¨ */
                position: relative;
            }
            
            /* æ­·å²è¨˜éŒ„æœˆä»½åˆ†éš”æ¢ */
            .mobile-card-table tbody tr.history-month-row {
                display: block;
                padding: 8px 15px;
                background: #f7faff;
            }

            /* å–®å…ƒæ ¼æ¨£å¼ */
            .mobile-card-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 4px 0; /* æ¸›å°‘ä¸Šä¸‹é–“è·ï¼Œæ›´ç·Šæ¹Š */
                border-bottom: none; /* ç§»é™¤å…§éƒ¨ç·šæ¢ï¼Œåªç•™è¡Œåº•ç·š */
                text-align: right;
                font-size: 0.95rem;
                width: 100%;
                box-sizing: border-box;
            }

            /* å·¦å´æ¨™é¡Œ (Data Label) */
            .mobile-card-table td::before {
                content: attr(data-label);
                font-weight: normal;
                color: #888;
                font-size: 0.85rem;
                margin-right: 15px;
                text-align: left;
                flex-shrink: 0;
            }

            /* è‚¡ç¥¨æ¨™é¡Œåˆ— (ç¬¬ä¸€è¡Œ) - ç‰¹åˆ¥è™•ç† */
            .mobile-card-table td[data-label="è‚¡ç¥¨"], 
            .mobile-card-table td[data-label="æ—¥æœŸ"] {
                padding-bottom: 8px;
                margin-bottom: 8px;
                border-bottom: 1px dashed #eee;
                font-size: 1rem;
            }
            .mobile-card-table td[data-label="è‚¡ç¥¨"]::before,
            .mobile-card-table td[data-label="æ—¥æœŸ"]::before { display: none; }
            
            .mobile-card-table td[data-label="è‚¡ç¥¨"] {
                justify-content: flex-start;
                gap: 10px;
            }
            
            /* å±•é–‹ç®­é ­æŒ‡ç¤º */
            .mobile-card-table td[data-label="è‚¡ç¥¨"]::after,
            .mobile-card-table td[data-label="æ—¥æœŸ"]::after {
                content: 'â–¼';
                color: #ddd;
                font-size: 0.8rem;
                margin-left: auto; /* æ¨åˆ°æœ€å³ */
                transition: transform 0.3s;
            }
            .mobile-card-table tr.expanded td[data-label="è‚¡ç¥¨"]::after,
            .mobile-card-table tr.expanded td[data-label="æ—¥æœŸ"]::after {
                transform: rotate(180deg);
                color: var(--primary);
            }

            /* --- éš±è—æ¬¡è¦è³‡è¨Š (é è¨­) --- */
            /* é€™æ˜¯ä½ è¦ºå¾—ä¸å°‹å¸¸çš„åœ°æ–¹ï¼Œç¾åœ¨æ”¹ç‚º display: none å®Œå…¨éš±è—ï¼Œå±•é–‹æ™‚ç”¨ flex */
            .mobile-card-table td.mobile-hidden {
                display: none; 
            }
            /* å±•é–‹æ™‚é¡¯ç¤ºæ¬¡è¦è³‡è¨Š */
            .mobile-card-table tr.expanded td.mobile-hidden {
                display: flex;
                animation: fadeIn 0.2s ease-in;
                background: #fdfdfd;
                padding: 8px;
                margin: 2px 0;
                border-radius: 4px;
            }
            /* è¼¸å…¥æ¡†å„ªåŒ– */
            .mobile-card-table input[type="number"] {
                width: 100px;
                text-align: right;
                border: 1px solid #ddd;
                padding: 6px;
                background: #fff;
            }

            @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

            /* è©³ç´°è³‡æ–™è¡Œ (Detail Row) */
            .mobile-card-table tr.detail-row {
                background: #fafafa;
                border-bottom: 1px solid #e8e8e8;
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
            }
            .mobile-card-table tr.detail-row td {
                display: block;
                padding: 0;
            }
            .detail-content {
                padding: 15px;
            }

            /* --- äº¤æ˜“æµæ°´å¸³çš„æ‰‹æ©Ÿç‰ˆå„ªåŒ– --- */
            /* è®“é‡é»è³‡è¨Šï¼ˆç¸½è®Šå‹•ï¼‰å³ä½¿åœ¨æ”¶èµ·ç‹€æ…‹ä¹Ÿé¡¯ç¤ºåœ¨ç¬¬ä¸€è¡Œ */
            .history-primary-info {
                display: flex;
                justify-content: space-between;
                width: 100%;
                font-weight: bold;
            }
            .history-sub-info {
                font-size: 0.85rem;
                color: #666;
                margin-top: 4px;
                display: block; /* ç¢ºä¿æ›è¡Œ */
                text-align: left;
            }
        }
    </style>
</head>
<body>

<div class="container">

    <!-- KPI å€åŸŸ -->
    <div class="card">
        <h3>ğŸ“Š æŠ•è³‡çµ„åˆç¸½è¦½</h3>
        <div class="dashboard-grid">
            <div class="kpi-box">
                <div class="kpi-title">ç¸½æŠ•å…¥æˆæœ¬ (æœ¬é‡‘)</div>
                <div class="small-text" style="margin-bottom:5px">(å«è²·å…¥åŠè³£å‡ºæ‰‹çºŒè²»)</div>
                <div class="kpi-val" id="kpi-cost">$0.00</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-title">ç•¶å‰æŒå€‰å¸‚å€¼</div>
                <div class="kpi-val" id="kpi-market">$0.00</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-title">ç¸½å·²æ”¶è‚¡æ¯</div>
                <div class="kpi-val text-up" id="kpi-div">$0.00</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-title">æ·¨å›å ± (å«å·²å¯¦ç¾æç›Š)</div>
                <div class="kpi-val" id="kpi-pnl">$0.00</div>
                <div class="small-text" id="kpi-pnl-pct">0.00%</div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢äº¤æ˜“ -->
    <div class="card" style="border-left: 5px solid var(--primary);">
        <h3>ğŸ“ æ–°å¢äº¤æ˜“ / æ”¶æ¯è¨˜éŒ„</h3>
        
        <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 150px;">
                <label class="small-text">æ—¥æœŸ</label>
                <input type="date" id="batch-date">
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label class="small-text">è©²æ¬¡ç¸½æ‰‹çºŒè²» ($)</label>
                <input type="number" id="batch-fee" value="50">
            </div>
        </div>

        <table id="batch-input-table">
            <thead>
                <tr>
                    <th style="width: 25%">é¡å‹</th>
                    <th style="width: 20%">ä»£è™Ÿ</th>
                    <th style="width: 25%">é‡‘é¡ / å–®åƒ¹</th>
                    <th style="width: 20%">è‚¡æ•¸</th>
                    <th style="width: 10%"></th>
                </tr>
            </thead>
            <tbody id="batch-body"></tbody>
        </table>
        
        <div class="btn-row">
            <button class="btn btn-outline" onclick="addBatchRow()">+ åŠ å…¥ä¸€è¡Œ</button>
            <button class="btn btn-primary" onclick="saveBatchTransaction()">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨˜éŒ„</button>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œ -->
    <div class="card">
        <h3>ğŸ† è‚¡ç¥¨è¡¨ç¾æ’è¡Œæ¦œ <span class="small-text">å«å·²å¯¦ç¾æç›Š (è³£å‡ºè³ºè•)</span></h3>
        <div class="small-text" style="margin-bottom: 10px;">
            * <b>è‚¡æ¯ç‡ (Yield)</b> = ç¸½è‚¡æ¯ / æ­·å²ç¸½æŠ•å…¥æˆæœ¬<br>
            * <b>ç¸½å›å ± (Total)</b> = (å¸‚å€¼ + è‚¡æ¯ + è³£å‡ºå–å› - ç¸½æŠ•å…¥)
        </div>
        <!-- ä¿®æ­£ï¼šåŠ å…¥ full-bleed-mobile é¡åˆ¥ï¼Œç§»é™¤ overflow-x: auto (æ‰‹æ©Ÿç‰ˆæ”¹ç”¨å¡ç‰‡é¡¯ç¤ºï¼Œä¸éœ€è¦æ©«å‘æ²å‹•) -->
        <div class="full-bleed-mobile">
            <table id="roi-table" class="mobile-card-table">
                <thead>
                    <tr>
                        <th onclick="sortRoi('code')">è‚¡ç¥¨ <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('totalInvested')">ç¸½æŠ•å…¥æˆæœ¬ <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('totalDiv')">ç¸½è‚¡æ¯ <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('realizedPnl')">å·²å¹³å€‰æç›Š <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('yield')">è‚¡æ¯ç‡ <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('totalProfit')">ç¸½å›å ± ($) <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('totalRetPct')">ç¸½å›å ±ç‡ (%) <span class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- æŒå€‰ç¾æ³ -->
    <div class="card">
        <h3>ğŸ’¼ æŒå€‰ç¾æ³ <button class="btn btn-success" style="font-size:0.8rem; padding:4px 8px;" onclick="fetchYahooPrices()">ğŸ”„ æ›´æ–°ç¾åƒ¹</button></h3>
        <div class="small-text">é»æ“Šè‚¡ç¥¨å¯å±•é–‹/æ‘ºç–Šè©³ç´°è³‡æ–™åŠè¼¸å…¥ç¾åƒ¹</div>
        
        <!-- ä¿®æ­£ï¼šåŠ å…¥ full-bleed-mobile é¡åˆ¥ -->
        <div class="full-bleed-mobile">
            <table id="portfolio-table" class="mobile-card-table">
                <thead>
                    <tr>
                        <th width="20%" onclick="sortPortfolio('code')">è‚¡ç¥¨ <span class="sort-icon"></span></th>
                        <th width="15%" onclick="sortPortfolio('qty')">æŒå€‰è‚¡æ•¸ <span class="sort-icon"></span></th>
                        <th width="15%" onclick="sortPortfolio('avgPrice')">å¹³å‡è²·å…¥åƒ¹ <span class="sort-icon"></span></th>
                        <th width="15%">ç¾åƒ¹ (å¯è¼¸å…¥)</th>
                        <th width="20%" onclick="sortPortfolio('marketVal')">å¸‚å€¼ <span class="sort-icon"></span></th>
                        <th width="15%" onclick="sortPortfolio('paperPnl')">å¸³é¢ç›ˆè™§ <span class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- åœ–è¡¨å€åŸŸ -->
    <div class="card">
        <h3>ğŸ“ˆ è³‡ç”¢è¶¨å‹¢èˆ‡åˆ†ä½ˆ</h3>
        <div class="grid-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="height: 300px;">
                <canvas id="trendChart1"></canvas>
            </div>
            <div style="height: 300px;">
                <canvas id="trendChart2"></canvas>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;" class="grid-charts">
            <div style="height: 300px;">
                <canvas id="pieChart"></canvas>
            </div>
            <div style="height: 300px;">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>

    <!-- åŒ¯å…¥åŠŸèƒ½ -->
    <div class="card" style="border: 2px dashed var(--primary); background: #f9fbff;">
        <h3>ğŸ“¤ Excel æ•¸æ“šæ‰¹é‡åŒ¯å…¥ (å°ˆæ¥­ç‰ˆé‚è¼¯)</h3>
        <div class="import-grid">
            <div>
                <label><b>1. æœˆä¾›è¨˜éŒ„è¡¨ (v5.0 é‚è¼¯)</b></label>
                <textarea id="excel-buy-area" rows="5" placeholder="è²¼ä¸Šæœˆä¾›è¡¨ç¯„åœ..."></textarea>
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="importBuyData()">åŒ¯å…¥è²·å…¥åŠè‚¡æ¯</button>
            </div>
            <div>
                <label><b>2. è³£å‡ºè‚¡ç¥¨è¡¨ (v5.2 é‚è¼¯ A1:X4)</b></label>
                <textarea id="excel-sell-area" rows="5" placeholder="è²¼ä¸Šè³£å‡ºè¡¨ A1:X4 ç¯„åœ..."></textarea>
                <button class="btn btn-danger" style="width:100%; margin-top:10px;" onclick="importSellData()">åŒ¯å…¥è³£å‡ºè¨˜éŒ„</button>
            </div>
        </div>
    </div>

    <!-- äº¤æ˜“æµæ°´å¸³ -->
    <div class="card">
        <h3>ğŸ—‚ï¸ äº¤æ˜“æµæ°´å¸³ (èˆŠåˆ°æ–°)</h3>
        <div class="full-bleed-mobile" style="max-height: 500px; overflow-y: auto;">
            <!-- åŠ å…¥ mobile-card-table é¡åˆ¥ï¼Œå¥—ç”¨ç›¸åŒçš„æ¨£å¼ -->
            <table id="history-table" class="mobile-card-table">
                <thead>
                    <tr>
                        <th style="width: 15%">æ—¥æœŸ</th>
                        <th style="width: 15%">ä»£è™Ÿ</th>
                        <th style="width: 10%">å‹•ä½œ</th>
                        <th style="width: 12%">å–®åƒ¹</th>
                        <th style="width: 10%">è‚¡æ•¸</th>
                        <th style="width: 12%">æ‰‹çºŒè²»</th>
                        <th style="width: 15%">ç¸½è®Šå‹•</th>
                        <th style="width: 11%"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="margin-top: 10px; text-align: right; padding: 0 10px;">
            <button class="btn btn-sm btn-danger" onclick="clearAllData()">âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>

</div>

<script>
    // å•Ÿç”¨ Chart.js DataLabels
    Chart.register(ChartDataLabels);

    // --- å…§å»ºè‚¡ç¥¨ä¸­æ–‡åç¨±æ˜ å°„ ---
    const stockMap = {
        "0005.HK": "æ»™è±æ§è‚¡", "0012.HK": "æ’åŸºåœ°ç”¢", "0027.HK": "éŠ€æ²³å¨›æ¨‚",
        "0388.HK": "é¦™æ¸¯äº¤æ˜“æ‰€", "0823.HK": "é ˜å±•æˆ¿ç”¢", "0883.HK": "ä¸­æµ·æ²¹",
        "2638.HK": "æ¸¯ç‡ˆ-SS", "2800.HK": "ç›ˆå¯ŒåŸºé‡‘", "0001.HK": "é•·å’Œ",
        "0003.HK": "ç…¤æ°£", "0011.HK": "æ’ç”ŸéŠ€è¡Œ", "0016.HK": "æ–°é´»åŸº",
        "0066.HK": "æ¸¯éµ", "0700.HK": "é¨°è¨Š", "09988.HK": "é˜¿é‡Œ",
        "03690.HK": "ç¾åœ˜", "01299.HK": "å‹é‚¦", "00939.HK": "å»ºè¡Œ",
        "01398.HK": "å·¥è¡Œ", "03988.HK": "ä¸­è¡Œ"
    };

    function getStockName(code) {
        if(!code) return "";
        let c = code.toUpperCase();
        if(!c.includes('.HK')) c += '.HK';
        let name = stockMap[c] || c;
        // é™åˆ¶é•·åº¦ 6 å­—
        if (name.length > 6) name = name.substring(0, 6);
        if (stockMap[c]) return `${c.replace('.HK','')} ${name}`;
        return c;
    }

    // --- å…¨å±€è®Šæ•¸ ---
    let transactions = JSON.parse(localStorage.getItem('stock_v4_trans')) || [];
    let priceCache = JSON.parse(localStorage.getItem('stock_v4_prices')) || {};
    let batchTemplate = JSON.parse(localStorage.getItem('stock_v4_template')) || [];

    // æ’åºç‹€æ…‹
    let portfolioSort = { key: 'marketVal', order: 'desc' };
    let roiSort = { key: 'totalRetPct', order: 'desc' };

    document.getElementById('batch-date').valueAsDate = new Date();
    
    // åˆå§‹åŒ–è¼¸å…¥æ¡†
    if (batchTemplate.length > 0) {
        batchTemplate.forEach(item => addBatchRow(item.code, item.qty, 'buy'));
    } else {
        addBatchRow();
    }

    let trendChartInst1 = null;
    let trendChartInst2 = null;
    let pieChartInst = null;
    let barChartInst = null;

    // å•Ÿå‹•
    renderAll();

    // --- æ ¸å¿ƒè¨ˆç®—å¼•æ“ ---
    function getPortfolioAnalysis() {
        let p = {};
        
        let sortedTrans = [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date));

        sortedTrans.forEach(t => {
            if (!p[t.code]) {
                p[t.code] = { 
                    qty: 0, 
                    currentCost: 0, 
                    totalInvested: 0, 
                    totalDiv: 0, 
                    soldCash: 0, 
                    soldCost: 0,
                    sellFees: 0, 
                    grossSold: 0 
                };
            }
            let stock = p[t.code];

            if (t.type === 'buy') {
                stock.qty += t.qty;
                stock.currentCost += t.total;
                stock.totalInvested += t.total;
            } 
            else if (t.type === 'sell') {
                let avgCost = stock.qty > 0 ? (stock.currentCost / stock.qty) : 0;
                let costOfSoldPart = avgCost * t.qty;
                
                let fee = t.fee || 0;
                let gross = t.total + fee;

                stock.qty -= t.qty;
                stock.currentCost -= costOfSoldPart;
                stock.soldCost += costOfSoldPart;
                stock.soldCash += t.total;
                stock.sellFees += fee;
                stock.grossSold += gross;
                
                if(stock.qty <= 0.0001) {
                    stock.qty = 0;
                    stock.currentCost = 0;
                }
            } 
            else if (t.type === 'dividend_cash' || t.type === 'dividend') {
                stock.totalDiv += t.total;
            } 
            else if (t.type === 'dividend_scrip') {
                stock.qty += t.qty;
            }
        });
        return p;
    }

    // --- æ ¼å¼åŒ–å·¥å…· ---
    function fmtMoney(num) {
        return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // --- æ¸²æŸ“ UI ---
    function renderAll() {
        const portfolio = getPortfolioAnalysis();
        renderKPI(portfolio);
        renderPortfolioTable(portfolio);
        renderROITable(portfolio);
        renderHistory();
        renderCharts(portfolio);
    }

    // 1. æ¸²æŸ“ KPI
    function renderKPI(p) {
        let totalCost = 0;   
        let totalMarket = 0; 
        let totalDiv = 0;    
        let totalSoldCash = 0; 
        let totalInvestedAllTime = 0; 
        let totalSellFees = 0; 

        for (let c in p) {
            const s = p[c];
            const price = priceCache[c] || 0;
            totalCost += s.currentCost;
            totalMarket += (s.qty * price);
            totalDiv += s.totalDiv;
            totalSoldCash += s.soldCash;
            totalInvestedAllTime += s.totalInvested;
            totalSellFees += s.sellFees;
        }

        const adjustedTotalInvested = totalInvestedAllTime + totalSellFees;
        const totalReturn = (totalMarket + totalDiv + totalSoldCash) - totalInvestedAllTime;
        const retPct = adjustedTotalInvested > 0 ? (totalReturn / adjustedTotalInvested * 100) : 0;

        document.getElementById('kpi-cost').textContent = '$' + fmtMoney(adjustedTotalInvested);
        document.getElementById('kpi-market').textContent = '$' + fmtMoney(totalMarket);
        document.getElementById('kpi-div').textContent = '$' + fmtMoney(totalDiv);
        
        const pnlEl = document.getElementById('kpi-pnl');
        pnlEl.textContent = (totalReturn>=0?'+':'') + '$' + fmtMoney(totalReturn);
        
        pnlEl.className = 'kpi-val'; 
        if(totalReturn >= 0) pnlEl.classList.add('text-up');
        else pnlEl.classList.add('text-down');
        
        const pctEl = document.getElementById('kpi-pnl-pct');
        pctEl.textContent = (retPct>=0?'+':'') + retPct.toFixed(2) + '%';
        pctEl.className = retPct >= 0 ? 'small-text text-up' : 'small-text text-down';
    }

    // 2. æ¸²æŸ“æŒå€‰è¡¨æ ¼ (å„ªåŒ–æŠ˜ç–Šé‚è¼¯)
    function sortPortfolio(key) {
        if (portfolioSort.key === key) {
            portfolioSort.order = portfolioSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            portfolioSort.key = key;
            portfolioSort.order = 'desc';
        }
        renderPortfolioTable(getPortfolioAnalysis());
    }

    function renderPortfolioTable(p) {
        const tbody = document.querySelector('#portfolio-table tbody');
        tbody.innerHTML = '';
        
        let rows = [];
        for (let c in p) {
            const s = p[c];
            if (s.qty <= 0.01) continue;
            const price = priceCache[c] || 0;
            const marketVal = s.qty * price;
            const avgPrice = s.qty > 0 ? (s.currentCost / s.qty) : 0;
            const paperPnl = marketVal - s.currentCost;

            rows.push({
                code: c,
                name: getStockName(c),
                qty: s.qty,
                avgPrice: avgPrice,
                price: price,
                marketVal: marketVal,
                paperPnl: paperPnl,
                data: s
            });
        }

        rows.sort((a, b) => {
            let valA = a[portfolioSort.key];
            let valB = b[portfolioSort.key];
            if (typeof valA === 'string') return portfolioSort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            return portfolioSort.order === 'asc' ? valA - valB : valB - valA;
        });

        rows.forEach(r => {
            const rowId = `row-${r.code.replace('.','-')}`;
            // æ³¨æ„ï¼šdata-label çš„ mobile-hidden class ç”¨æ–¼æ‰‹æ©Ÿç‰ˆé è¨­éš±è—
            tbody.innerHTML += `
                <tr class="clickable-row" onclick="toggleDetail('${rowId}', this)">
                    <td data-label="è‚¡ç¥¨">
                        <div><b>${r.name}</b> <span class="small-text">${r.code}</span></div>
                    </td>
                    <td data-label="å¸‚å€¼">$${fmtMoney(r.marketVal)}</td>
                    <td data-label="å¸³é¢ç›ˆè™§" class="${r.paperPnl>=0?'text-up':'text-down'}">${r.paperPnl>=0?'+':''}${fmtMoney(r.paperPnl)}</td>
                    
                    <!-- é€™äº›æ˜¯æ‰‹æ©Ÿç‰ˆé è¨­éš±è—ï¼Œå±•é–‹å¾Œé¡¯ç¤ºçš„ -->
                    <td data-label="ç¾åƒ¹ (è¼¸å…¥)" class="mobile-hidden" style="background:#e6f7ff;">
                        <input type="number" value="${r.price}" placeholder="ç¾åƒ¹" onclick="event.stopPropagation()" onchange="updatePrice('${r.code}', this.value)">
                    </td>
                    <td data-label="æŒå€‰è‚¡æ•¸" class="mobile-hidden">${r.qty.toFixed(0)}</td>
                    <td data-label="å¹³å‡è²·å…¥åƒ¹" class="mobile-hidden">$${fmtMoney(r.avgPrice)}</td>
                </tr>
                <tr id="${rowId}" class="detail-row">
                    <td colspan="6">
                        <div class="detail-content">
                            <div class="detail-item"><strong>æŒå€‰æˆæœ¬</strong> $${fmtMoney(r.data.currentCost)}</div>
                            <div class="detail-item"><strong>æ­·å²ç¸½è‚¡æ¯</strong> $${fmtMoney(r.data.totalDiv)}</div>
                            <div class="detail-item"><strong>å·²è®Šç¾é‡‘é¡</strong> $${fmtMoney(r.data.soldCash)}</div>
                            <div class="detail-item"><strong>æ­·å²ç¸½æŠ•å…¥</strong> $${fmtMoney(r.data.totalInvested)}</div>
                            <div class="detail-item"><strong>å·²å¹³å€‰æç›Š</strong> <span class="${(r.data.soldCash - r.data.soldCost)>=0?'text-up':'text-down'}">$${fmtMoney(r.data.soldCash - r.data.soldCost)}</span></div>
                            <div class="detail-item"><strong>è³£å‡ºæ‰‹çºŒè²»</strong> $${fmtMoney(r.data.sellFees)}</div>
                        </div>
                    </td>
                </tr>
            `;
        });
        updateSortIcons('portfolio-table', portfolioSort);
    }

    function toggleDetail(rowId, mainRow) {
        const row = document.getElementById(rowId);
        
        // åˆ‡æ›é¡¯ç¤ºç‹€æ…‹
        if(row.style.display === 'none' || row.style.display === '') {
            // æ‰‹æ©Ÿç‰ˆä½¿ç”¨ block ä»¥æ”¯æ´å…¨å¯¬ï¼Œé›»è…¦ç‰ˆä½¿ç”¨ table-row
            const isMobile = window.innerWidth <= 768;
            row.style.display = isMobile ? 'block' : 'table-row';
            mainRow.classList.add('expanded');
        } else {
            row.style.display = 'none';
            mainRow.classList.remove('expanded');
        }
    }

    // 3. æ¸²æŸ“ ROI æ’è¡Œæ¦œ (å„ªåŒ–æŠ˜ç–Šé‚è¼¯)
    function sortRoi(key) {
        if (roiSort.key === key) {
            roiSort.order = roiSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            roiSort.key = key;
            roiSort.order = 'desc';
        }
        renderROITable(getPortfolioAnalysis());
    }

    function renderROITable(p) {
        const tbody = document.querySelector('#roi-table tbody');
        tbody.innerHTML = '';

        let rows = [];
        for (let c in p) {
            const s = p[c];
            if (s.totalInvested === 0 && s.qty === 0 && s.totalDiv === 0) continue;

            const price = priceCache[c] || 0;
            const marketVal = s.qty * price;
            const realizedPnl = s.soldCash - s.soldCost;
            const totalProfit = (marketVal + s.totalDiv + s.soldCash) - s.totalInvested;
            const adjustedInv = s.totalInvested + s.sellFees;
            const yieldRate = adjustedInv > 0 ? (s.totalDiv / adjustedInv) * 100 : 0;
            const totalRetPct = adjustedInv > 0 ? (totalProfit / adjustedInv) * 100 : 0;

            rows.push({
                code: c,
                name: getStockName(c),
                totalInvested: adjustedInv,
                totalDiv: s.totalDiv,
                realizedPnl: realizedPnl,
                yield: yieldRate,
                totalRetPct: totalRetPct,
                totalProfit: totalProfit
            });
        }

        rows.sort((a, b) => {
            let valA = a[roiSort.key];
            let valB = b[roiSort.key];
            if (typeof valA === 'string') return roiSort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            return roiSort.order === 'asc' ? valA - valB : valB - valA;
        });

        rows.forEach((r, idx) => {
            let badge = '';
            if (roiSort.key === 'totalRetPct' && roiSort.order === 'desc') {
                if (idx === 0) badge = '<span class="badge bg-gold">1</span> ';
                if (idx === 1) badge = '<span class="badge bg-gray">2</span> ';
                if (idx === 2) badge = '<span class="badge bg-bronze">3</span> ';
            }

            tbody.innerHTML += `
                <tr class="clickable-row" onclick="this.classList.toggle('expanded')">
                    <td data-label="è‚¡ç¥¨"><div>${badge}<b>${r.name}</b> <span class="small-text">${r.code}</span></div></td>
                    <td data-label="ç¸½å›å ±ç‡ (%)" class="${r.totalRetPct>=0?'text-up':'text-down'}"><b>${r.totalRetPct>=0?'+':''}${r.totalRetPct.toFixed(2)}%</b></td>
                    
                    <!-- éš±è—é …ç›® -->
                    <td data-label="ç¸½å›å ± ($)" class="mobile-hidden ${r.totalProfit>=0?'text-up':'text-down'}"><b>${r.totalProfit>=0?'+':''}${fmtMoney(r.totalProfit)}</b></td>
                    <td data-label="å·²å¹³å€‰æç›Š" class="mobile-hidden ${r.realizedPnl>=0?'text-up':'text-down'}">${r.realizedPnl>=0?'+':''}${fmtMoney(r.realizedPnl)}</td>
                    <td data-label="ç¸½æŠ•å…¥æˆæœ¬" class="mobile-hidden">$${fmtMoney(r.totalInvested)}</td>
                    <td data-label="ç¸½è‚¡æ¯" class="mobile-hidden">$${fmtMoney(r.totalDiv)}</td>
                    <td data-label="è‚¡æ¯ç‡" class="text-up mobile-hidden">${r.yield.toFixed(2)}%</td>
                </tr>
            `;
        });
        updateSortIcons('roi-table', roiSort);
    }

    function updateSortIcons(tableId, sortState) {
        document.querySelectorAll(`#${tableId} th`).forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.getAttribute('onclick') && th.getAttribute('onclick').includes(`'${sortState.key}'`)) {
                th.classList.add(sortState.order === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        });
    }

    // --- åœ–è¡¨åŠŸèƒ½ ---
    function renderCharts(p) {
        const dates = [...new Set(transactions.map(t => t.date.substring(0,7)))].sort();
        
        let accRealizedPnl = 0; 
        let accDiv = 0;         
        let accHoldingCost = 0; 
        
        let dataRealized = [], dataDiv = [], dataHoldingCost = [], dataMarketLine = [];
        
        let currentTotalMarket = 0;
        for (let c in p) { if(p[c].qty > 0) currentTotalMarket += (p[c].qty * (priceCache[c]||0)); }

        let sorted = [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date));
        let monthly = {};
        
        let tempStock = {}; 

        sorted.forEach(t => {
            let m = t.date.substring(0,7);
            
            if(!tempStock[t.code]) tempStock[t.code] = { qty:0, cost:0 };
            let ts = tempStock[t.code];

            if(t.type === 'buy') {
                ts.qty += t.qty;
                ts.cost += t.total;
                accHoldingCost += t.total;
            }
            else if(t.type === 'dividend_cash') {
                accDiv += t.total;
            }
            else if(t.type === 'dividend_scrip') {
                ts.qty += t.qty;
            }
            else if(t.type === 'sell') {
                let avg = ts.qty > 0 ? ts.cost / ts.qty : 0;
                let costPart = avg * t.qty;
                
                let pnl = t.total - costPart;
                accRealizedPnl += pnl;

                ts.qty -= t.qty;
                ts.cost -= costPart;
                accHoldingCost -= costPart;
                
                if(ts.qty <= 0.0001) { ts.qty = 0; ts.cost = 0; }
            }

            monthly[m] = { realized: accRealizedPnl, div: accDiv, holding: accHoldingCost };
        });

        dates.forEach(m => {
            let lastR = dataRealized.length ? dataRealized[dataRealized.length-1] : 0;
            let lastD = dataDiv.length ? dataDiv[dataDiv.length-1] : 0;
            let lastH = dataHoldingCost.length ? dataHoldingCost[dataHoldingCost.length-1] : 0;
            
            if(monthly[m]) {
                dataRealized.push(monthly[m].realized);
                dataDiv.push(monthly[m].div);
                dataHoldingCost.push(monthly[m].holding);
            } else {
                dataRealized.push(lastR);
                dataDiv.push(lastD);
                dataHoldingCost.push(lastH);
            }
            dataMarketLine.push(currentTotalMarket);
        });

        // Chart 1
        if(trendChartInst1) trendChartInst1.destroy();
        trendChartInst1 = new Chart(document.getElementById('trendChart1'), {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    { label: 'ç´¯ç©è‚¡æ¯æ”¶å…¥', data: dataDiv, borderColor: '#52c41a', backgroundColor: 'rgba(82,196,26,0.1)', fill: true }
                ]
            },
            options: { 
                maintainAspectRatio: false, 
                plugins: { 
                    title: { display: true, text: 'ç´¯ç©è‚¡æ¯æ”¶å…¥è¶¨å‹¢' },
                    datalabels: { display: false } 
                } 
            }
        });

        // Chart 2
        if(trendChartInst2) trendChartInst2.destroy();
        trendChartInst2 = new Chart(document.getElementById('trendChart2'), {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    { label: 'ç´¯ç©æŒå€‰æˆæœ¬', data: dataHoldingCost, borderColor: '#1890ff', backgroundColor: 'rgba(24,144,255,0.1)', fill: true },
                    { label: 'ç¾æœ‰æŒå€‰åƒ¹å€¼ (åƒè€ƒç·š)', data: dataMarketLine, borderColor: '#f5222d', borderDash: [5, 5], fill: false, pointRadius: 0 }
                ]
            },
            options: { 
                maintainAspectRatio: false, 
                plugins: { 
                    title: { display: true, text: 'æˆæœ¬è¦æ¨¡ vs ç•¶å‰å¸‚å€¼' },
                    datalabels: { display: false }
                } 
            }
        });

        // Pie Chart
        if(pieChartInst) pieChartInst.destroy();
        let labels = [], data = [];
        let totalVal = 0;
        
        for(let c in p) { 
            if(p[c].qty>0) { 
                let v = p[c].qty * (priceCache[c]||0);
                totalVal += v;
            } 
        }

        for(let c in p) { 
            if(p[c].qty>0) { 
                let v = p[c].qty * (priceCache[c]||0);
                labels.push(getStockName(c).replace(/[0-9.]/g,'').substring(0,6) || c); 
                data.push(v); 
            } 
        }

        pieChartInst = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: ['#1890ff','#13c2c2','#52c41a','#fadb14','#f5222d','#722ed1','#eb2f96','#fa8c16'] }] },
            options: { 
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    datalabels: {
                        display: true, 
                        color: '#fff',
                        font: { weight: 'bold' },
                        formatter: (value, ctx) => {
                            let percentage = totalVal > 0 ? (value*100 / totalVal).toFixed(1)+"%" : "0%";
                            return percentage;
                        }
                    }
                }
            }
        });

        // Bar Chart
        if(barChartInst) barChartInst.destroy();
        let yearly = {};
        sorted.forEach(t => {
            if(t.type.includes('dividend') && !t.type.includes('scrip')) {
                let y = t.date.substring(0,4);
                yearly[y] = (yearly[y]||0) + t.total;
            }
        });
        barChartInst = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: Object.keys(yearly), datasets: [{ label: 'å¹´åº¦è‚¡æ¯æ”¶å…¥', data: Object.values(yearly), backgroundColor: '#13c2c2' }] },
            options: { 
                maintainAspectRatio: false,
                plugins: {
                    datalabels: { display: false } 
                }
            }
        });
    }

    // --- äº¤æ˜“è¨˜éŒ„ (èˆŠåˆ°æ–°) ---
    function renderHistory() {
        const tbody = document.querySelector('#history-table tbody');
        tbody.innerHTML = '';
        const list = [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        let currentMonth = '';

        list.forEach(t => {
            const m = t.date.substring(0, 7);
            if (m !== currentMonth) {
                currentMonth = m;
                // åŠ å…¥ mobile-card-table æ¨£å¼
                tbody.innerHTML += `<tr class="history-month-row"><td colspan="8">${m.replace('-', 'å¹´')}æœˆ</td></tr>`;
            }

            let act = '', valClass = '';
            let actionIcon = '';
            if(t.type==='buy') { act='è²·å…¥'; valClass='text-down'; actionIcon='ğŸ“¥'; }
            else if(t.type==='sell') { act='è³£å‡º'; valClass='text-up'; actionIcon='ğŸ“¤'; }
            else if(t.type.includes('cash')) { act='æ”¶æ¯(éŒ¢)'; valClass='text-up'; actionIcon='ğŸ’°'; }
            else if(t.type.includes('scrip')) { act='æ”¶æ¯(è²¨)'; valClass='text-up'; actionIcon='ğŸ'; }
            
            let priceStr = t.price ? `$${fmtMoney(t.price)}` : '-';
            let qtyStr = t.qty ? t.qty : '-';
            let feeStr = t.fee ? `$${fmtMoney(t.fee)}` : '-';
            let totalStr = '';

            if (t.type === 'buy') totalStr = `-$${fmtMoney(t.total)}`;
            else if (t.type === 'dividend_scrip') totalStr = `+${t.qty}è‚¡`;
            else totalStr = `+$${fmtMoney(t.total)}`;
            
            // é€™è£¡ä½¿ç”¨äº†æ–°çš„çµæ§‹ï¼š
            // 1. data-label="æ—¥æœŸ" åŒ…å«äº†æ—¥æœŸå’Œé‡é» (ç‚ºäº†è®“å®ƒå€‘åœ¨æ‰‹æ©Ÿç‰ˆç½®é ‚)
            // 2. mobile-hidden class ç”¨æ–¼æ¬¡è¦è³‡è¨Š (å–®åƒ¹/è‚¡æ•¸/æ‰‹çºŒè²»)
            // 3. onclick toggles 'expanded'
            tbody.innerHTML += `
                <tr class="history-item-row" onclick="this.classList.toggle('expanded')">
                    <td data-label="æ—¥æœŸ">
                        <div class="history-primary-info">
                            <span>${t.date.slice(5)} ${actionIcon} ${act}</span>
                            <span class="${valClass}">${totalStr}</span>
                        </div>
                    </td>
                    
                    <td data-label="ä»£è™Ÿ">
                        <div><b>${getStockName(t.code)}</b> <span class="small-text">${t.code}</span></div>
                    </td>
                    
                    <!-- æ‰‹æ©Ÿç‰ˆé è¨­éš±è—çš„æ¬¡è¦è³‡è¨Š -->
                    <td data-label="å–®åƒ¹" class="mobile-hidden">${priceStr}</td>
                    <td data-label="è‚¡æ•¸" class="mobile-hidden">${qtyStr}</td>
                    <td data-label="æ‰‹çºŒè²»" class="mobile-hidden small-text">${feeStr}</td>
                    
                    <!-- æ¡Œé¢ç‰ˆéœ€è¦é¡¯ç¤ºçš„æ¬„ä½ (æ‰‹æ©Ÿç‰ˆé€é CSS éš±è—äº†é‡è¤‡è³‡è¨Š) -->
                    <td class="desktop-only" style="display:none">${act}</td> 
                    <td class="desktop-only ${valClass}" style="display:none; font-weight:bold">${totalStr}</td>
                    
                    <td data-label="æ“ä½œ"><button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); delTrans(${t.id})">åˆªé™¤</button></td>
                </tr>
            `;
        });
    }

    // --- è¼”åŠ©åŠŸèƒ½ ---
    function addBatchRow(code='', qty='', type='buy') {
        const tbody = document.getElementById('batch-body');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <select class="row-type" onchange="handleTypeChange(this)">
                    <option value="buy" ${type==='buy'?'selected':''}>è²·å…¥</option>
                    <option value="dividend_cash">æ”¶æ¯ (æ´¾éŒ¢)</option>
                    <option value="dividend_scrip">æ”¶æ¯ (æ´¾è²¨)</option>
                    <option value="sell">è³£å‡º</option>
                </select>
            </td>
            <td><input type="text" class="row-code" value="${code}" placeholder="0005.HK" oninput="this.value=this.value.toUpperCase()"></td>
            <td><input type="number" class="row-price" step="0.01" placeholder="å–®åƒ¹"></td>
            <td><input type="number" class="row-qty" value="${qty}" placeholder="è‚¡æ•¸"></td>
            <td><button class="btn btn-danger" style="padding:5px;" onclick="this.closest('tr').remove()">X</button></td>
        `;
        tbody.appendChild(tr);
        handleTypeChange(tr.querySelector('.row-type'));
    }

    function handleTypeChange(select) {
        const tr = select.closest('tr');
        const priceInp = tr.querySelector('.row-price');
        const qtyInp = tr.querySelector('.row-qty');
        const type = select.value;
        priceInp.disabled = false; qtyInp.disabled = false;
        priceInp.value = ''; qtyInp.value = '';
        if(type === 'dividend_cash') {
            priceInp.placeholder = "ç¸½é‡‘é¡ ($)"; qtyInp.disabled = true; qtyInp.placeholder = "-";
        } else if(type === 'dividend_scrip') {
            priceInp.disabled = true; priceInp.placeholder = "0"; qtyInp.placeholder = "æ”¶åˆ°è‚¡æ•¸";
        } else {
            priceInp.placeholder = "å–®åƒ¹"; qtyInp.placeholder = "è‚¡æ•¸";
        }
    }

    function saveBatchTransaction() {
        const date = document.getElementById('batch-date').value;
        const globalFee = parseFloat(document.getElementById('batch-fee').value) || 0;
        const rows = document.querySelectorAll('#batch-body tr');
        let newTrans = [];
        let totalBuyVal = 0;
        let template = [];
        rows.forEach(tr => {
            const type = tr.querySelector('.row-type').value;
            let code = tr.querySelector('.row-code').value.trim();
            const val1 = parseFloat(tr.querySelector('.row-price').value) || 0;
            const val2 = parseFloat(tr.querySelector('.row-qty').value) || 0;
            if(!code) return;
            if(!code.includes('.')) code += '.HK';
            let t = { id: Date.now()+Math.random(), date, type, code, price:0, qty:0, total:0, fee:0 };
            if(type === 'buy') {
                t.price = val1; t.qty = val2; t.total = val1*val2; totalBuyVal += t.total; template.push({code, qty: val2});
            } else if(type === 'sell') {
                t.price = val1; t.qty = val2; t.total = val1*val2; 
            } else if(type === 'dividend_cash') {
                t.total = val1;
            } else if(type === 'dividend_scrip') {
                t.qty = val2;
            }
            newTrans.push(t);
        });
        if(newTrans.length === 0) return;
        newTrans.forEach(t => {
            if(t.type === 'buy' && totalBuyVal > 0) { t.fee = globalFee * (t.total / totalBuyVal); t.total += t.fee; }
            if(t.type === 'sell') { 
                if(t.price > 0 && globalFee > 0) {
                     t.fee = globalFee; 
                     t.total -= t.fee;
                }
            }
        });
        transactions = transactions.concat(newTrans);
        transactions.sort((a,b) => new Date(a.date) - new Date(b.date));
        saveAndRefresh();
        if(template.length>0) localStorage.setItem('stock_v4_template', JSON.stringify(template));
        document.getElementById('batch-body').innerHTML = '';
        if(template.length>0) template.forEach(x => addBatchRow(x.code, x.qty)); else addBatchRow();
        alert("å·²å„²å­˜è¨˜éŒ„ï¼");
    }

    function saveAndRefresh() { 
        localStorage.setItem('stock_v4_trans', JSON.stringify(transactions)); 
        renderAll(); 
    }
    function updatePrice(code, val) {
        priceCache[code] = parseFloat(val);
        localStorage.setItem('stock_v4_prices', JSON.stringify(priceCache));
        renderAll();
    }
    async function fetchYahooPrices() {
        const p = getPortfolioAnalysis();
        const codes = Object.keys(p).filter(c => p[c].qty > 0);
        if (codes.length === 0) return alert("ç›®å‰æ²’æœ‰æŒå€‰éœ€è¦æ›´æ–°");
        let updated = 0;
        for (let code of codes) {
            try {
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${code}?interval=1d&range=1d`;
                const res = await fetch(url);
                const data = await res.json();
                const price = data.chart.result[0].meta.regularMarketPrice;
                if(price) { priceCache[code] = price; updated++; }
            } catch(e) { console.error(code, e); }
        }
        localStorage.setItem('stock_v4_prices', JSON.stringify(priceCache));
        renderAll();
        alert(`å·²æ›´æ–° ${updated} éš»è‚¡ç¥¨åƒ¹æ ¼`);
    }

    function importBuyData() {
        const raw = document.getElementById('excel-buy-area').value;
        if(!raw) return;
        const lines = raw.split('\n').map(l => l.split('\t'));
        const header = lines[0];
        let newItems = [];
        let stockCols = [];
        for(let col=0; col < header.length; col++) {
            let code = header[col] ? header[col].trim() : '';
            if(code && (code.includes('.') || !isNaN(code)) && code !== 'æ—¥æœŸ' && code !== 'æ‰‹çºŒè²»') {
                 if(!code.includes('.')) code += ".HK";
                 stockCols.push({ index: col, code: code });
            }
        }
        for(let i=1; i<lines.length; i++) {
            const r = lines[i];
            if(!r[0] || r[0].includes('å¹´')) continue;
            const date = r[0].trim().replace(/\//g, '-');
            const rowTotalFee = parseFloat(r[1]) || 0;
            let rowBuys = [];
            let rowBuyValue = 0;
            stockCols.forEach(sc => {
                const qty = parseFloat(r[sc.index]) || 0;
                let priceRaw = r[sc.index+1];
                if (typeof priceRaw === 'string') priceRaw = priceRaw.trim();
                const price = parseFloat(priceRaw) || 0;
                const div = parseFloat(r[sc.index+3]) || 0;
                if(qty > 0) {
                    if (price > 0) {
                        rowBuys.push({ code: sc.code, qty, price, rawTotal: qty*price });
                        rowBuyValue += (qty*price);
                    } else {
                         newItems.push({ id: Math.random(), date, type: 'dividend_scrip', code: sc.code, qty: qty, price: 0, total: 0, fee: 0 });
                    }
                }
                if(div > 0) newItems.push({ id: Math.random(), date, type: 'dividend_cash', code: sc.code, qty: 0, price: 0, total: div, fee: 0 });
            });
            rowBuys.forEach(b => {
                let allocatedFee = 0;
                if(rowBuyValue > 0) allocatedFee = rowTotalFee * (b.rawTotal / rowBuyValue);
                newItems.push({ id: Math.random(), date, type: 'buy', code: b.code, qty: b.qty, price: b.price, total: b.rawTotal + allocatedFee, fee: allocatedFee });
            });
        }
        transactions = [...transactions, ...newItems].sort((a,b)=>new Date(a.date)-new Date(b.date));
        saveAndRefresh();
        alert(`åŒ¯å…¥æˆåŠŸï¼å·²åŠ å…¥ ${newItems.length} ç­†è¨˜éŒ„ã€‚`);
        document.getElementById('excel-buy-area').value = '';
    }

    function importSellData() {
        const raw = document.getElementById('excel-sell-area').value;
        if(!raw) return;
        const lines = raw.split('\n').map(l => l.split('\t'));
        let newSells = [];
        for (let col = 0; col < lines[0].length; col += 4) {
            let code = lines[0][col] ? lines[0][col].trim() : "";
            if (!code || isNaN(code)) continue;
            if (!code.includes('.')) code += ".HK";
            for (let i = 2; i < lines.length; i++) {
                const r = lines[i];
                const date = r[col] ? r[col].trim().replace(/\//g, '-') : "";
                if (!date || date === "æ—¥æœŸ") continue;
                const fee = Math.abs(parseFloat(r[col+1])) || 0;
                const qty = Math.abs(parseFloat(r[col+2])) || 0;
                const price = parseFloat(r[col+3]) || 0;
                if (qty > 0 && price > 0) {
                    newSells.push({ id: Math.random(), date, type: 'sell', code, qty, price, total: (qty * price) - fee, fee });
                }
            }
        }
        transactions = [...transactions, ...newSells].sort((a,b)=>new Date(a.date)-new Date(b.date));
        saveAndRefresh();
        alert(`æˆåŠŸåŒ¯å…¥ ${newSells.length} ç­†è³£å‡ºè¨˜éŒ„`);
        document.getElementById('excel-sell-area').value = '';
    }

    function delTrans(id) {
        if(confirm("åˆªé™¤æ­¤è¨˜éŒ„ï¼Ÿ")) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('stock_v4_trans', JSON.stringify(transactions));
            renderAll();
        }
    }
    function clearAllData() {
        if(confirm("âš ï¸ ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿç„¡æ³•å¾©åŸï¼")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
