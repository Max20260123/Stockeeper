<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆä¾›è‚¡ç¥¨æ™ºèƒ½ç³»çµ± v6.0 (ç²¾ç¢ºè²¡å‹™ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --primary: #1890ff;
            --success: #52c41a;
            --danger: #f5222d;
            --warning: #faad14;
            --text: #333;
            --border: #e8e8e8;
            --hover: #f5f5f5;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background: var(--bg); color: var(--text); }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card { background: var(--card-bg); padding: 24px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
        h2, h3 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 12px; font-size: 1.1rem; color: #1f1f1f; display: flex; justify-content: space-between; align-items: center; }
        
        /* é¡è‰²å·¥å…· */
        .text-up { color: var(--success); font-weight: bold; }
        .text-down { color: var(--danger); font-weight: bold; }
        .text-neutral { color: #666; }
        .small-text { font-size: 0.85rem; color: #8c8c8c; font-weight: normal; }
        
        /* KPI å„€è¡¨æ¿ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .kpi-box { background: #fafafa; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid var(--border); }
        .kpi-title { font-size: 0.9rem; color: #666; margin-bottom: 8px; }
        .kpi-val { font-size: 1.4rem; font-weight: bold; color: #000; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; table-layout: fixed; }
        th { text-align: left; padding: 12px 8px; background: #fafafa; border-bottom: 2px solid var(--border); cursor: pointer; user-select: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        th:hover { background: #e6f7ff; }
        td { padding: 10px 8px; border-bottom: 1px solid var(--border); vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        
        /* å¯å±•é–‹çš„è©³ç´°è¡Œ */
        .clickable-row { cursor: pointer; transition: 0.2s; }
        .clickable-row:hover { background: var(--hover); }
        .detail-row { background-color: #f9f9f9; display: none; }
        .detail-content { padding: 15px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.85rem; color: #555; }
        .detail-item strong { display: block; color: #333; margin-bottom: 3px; }

        /* æ­·å²è¨˜éŒ„å°ˆç”¨æ¨£å¼ */
        #history-table { font-size: 0.85rem; }
        #history-table td, #history-table th { padding: 6px 8px; }
        .history-month-row { background: #e6f7ff; color: var(--primary); font-weight: bold; font-size: 0.9rem; border-top: 2px solid #bae7ff; }
        
        /* æ’åºåœ–ç¤º */
        .sort-icon::after { content: ' â†•'; font-size: 0.8em; color: #ccc; }
        .sort-asc::after { content: ' â†‘'; color: var(--primary); }
        .sort-desc::after { content: ' â†“'; color: var(--primary); }

        /* è¼¸å…¥æ§ä»¶ */
        input, select, textarea { padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; width: 100%; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; }
        input:disabled { background: #f5f5f5; cursor: not-allowed; }

        /* æŒ‰éˆ• */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid #d9d9d9; color: #666; }
        .btn-sm { padding: 2px 6px; font-size: 0.75rem; }
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }

        /* å¾½ç«  */
        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; color: white; font-weight: bold; }
        .bg-gold { background: #faad14; }
        .bg-gray { background: #bfbfbf; }
        .bg-bronze { background: #d48806; }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr 1fr; }
            .grid-charts { grid-template-columns: 1fr; }
            .import-grid { grid-template-columns: 1fr; }
            .container { padding: 10px; }
            .detail-content { grid-template-columns: 1fr; }
        }
    	.import-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>

<div class="container">

    <!-- KPI å€åŸŸ -->
    <div class="card">
        <h3>ğŸ“Š æŠ•è³‡çµ„åˆç¸½è¦½</h3>
        <div class="dashboard-grid">
            <div class="kpi-box">
                <div class="kpi-title">ç¸½æŠ•å…¥æˆæœ¬ (æœ¬é‡‘)</div>
                <div class="small-text" style="margin-bottom:5px">(å«è²·å…¥åŠè³£å‡ºæ‰‹çºŒè²»)</div>
                <div class="kpi-val" id="kpi-cost">$0.00</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-title">ç•¶å‰æŒå€‰å¸‚å€¼</div>
                <div class="kpi-val" id="kpi-market">$0.00</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-title">ç¸½å·²æ”¶è‚¡æ¯</div>
                <div class="kpi-val text-up" id="kpi-div">$0.00</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-title">æ·¨å›å ± (å«å·²å¯¦ç¾æç›Š)</div>
                <div class="kpi-val" id="kpi-pnl">$0.00</div>
                <div class="small-text" id="kpi-pnl-pct">0.00%</div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢äº¤æ˜“ -->
    <div class="card" style="border-left: 5px solid var(--primary);">
        <h3>ğŸ“ æ–°å¢äº¤æ˜“ / æ”¶æ¯è¨˜éŒ„</h3>
        
        <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 150px;">
                <label class="small-text">æ—¥æœŸ</label>
                <input type="date" id="batch-date">
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label class="small-text">è©²æ¬¡ç¸½æ‰‹çºŒè²» ($)</label>
                <input type="number" id="batch-fee" value="50">
            </div>
        </div>

        <table id="batch-input-table">
            <thead>
                <tr>
                    <th style="width: 25%">é¡å‹</th>
                    <th style="width: 20%">ä»£è™Ÿ</th>
                    <th style="width: 25%">é‡‘é¡ / å–®åƒ¹</th>
                    <th style="width: 20%">è‚¡æ•¸</th>
                    <th style="width: 10%"></th>
                </tr>
            </thead>
            <tbody id="batch-body"></tbody>
        </table>
        
        <div class="btn-row">
            <button class="btn btn-outline" onclick="addBatchRow()">+ åŠ å…¥ä¸€è¡Œ</button>
            <button class="btn btn-primary" onclick="saveBatchTransaction()">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨˜éŒ„</button>
        </div>
    </div>

    <!-- ä½ç½®äº¤æ›ï¼šç¾åœ¨æ’è¡Œæ¦œåœ¨ä¸Šæ–¹ -->
    <div class="card">
        <h3>ğŸ† è‚¡ç¥¨è¡¨ç¾æ’è¡Œæ¦œ <span class="small-text">å«å·²å¯¦ç¾æç›Š (è³£å‡ºè³ºè•)</span></h3>
        <div class="small-text" style="margin-bottom: 10px;">
            * <b>è‚¡æ¯ç‡ (Yield)</b> = ç¸½è‚¡æ¯ / æ­·å²ç¸½æŠ•å…¥æˆæœ¬<br>
            * <b>ç¸½å›å ± (Total)</b> = (å¸‚å€¼ + è‚¡æ¯ + è³£å‡ºå–å› - ç¸½æŠ•å…¥)
        </div>
        <div style="overflow-x: auto;">
            <table id="roi-table">
                <thead>
                    <tr>
                        <th onclick="sortRoi('code')">è‚¡ç¥¨ <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('totalInvested')">ç¸½æŠ•å…¥æˆæœ¬ <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('totalDiv')">ç¸½è‚¡æ¯ <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('realizedPnl')">å·²å¹³å€‰æç›Š <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('yield')">è‚¡æ¯ç‡ <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('totalProfit')">ç¸½å›å ± ($) <span class="sort-icon"></span></th>
                        <th onclick="sortRoi('totalRetPct')">ç¸½å›å ±ç‡ (%) <span class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- ä½ç½®äº¤æ›ï¼šç¾åœ¨æŒå€‰åœ¨ä¸‹æ–¹ -->
    <div class="card">
        <h3>ğŸ’¼ æŒå€‰ç¾æ³ <button class="btn btn-success" style="font-size:0.8rem; padding:4px 8px;" onclick="fetchYahooPrices()">ğŸ”„ æ›´æ–°ç¾åƒ¹</button></h3>
        <div class="small-text">é»æ“Šè‚¡ç¥¨è¡Œå¯æŸ¥çœ‹è©³ç´°è³‡æ–™</div>
        <div style="overflow-x: auto;">
            <table id="portfolio-table">
                <thead>
                    <tr>
                        <th width="20%" onclick="sortPortfolio('code')">è‚¡ç¥¨ <span class="sort-icon"></span></th>
                        <th width="15%" onclick="sortPortfolio('qty')">æŒå€‰è‚¡æ•¸ <span class="sort-icon"></span></th>
                        <th width="15%" onclick="sortPortfolio('avgPrice')">å¹³å‡è²·å…¥åƒ¹ <span class="sort-icon"></span></th>
                        <th width="15%">ç¾åƒ¹ (å¯è¼¸å…¥)</th>
                        <th width="20%" onclick="sortPortfolio('marketVal')">å¸‚å€¼ <span class="sort-icon"></span></th>
                        <th width="15%" onclick="sortPortfolio('paperPnl')">å¸³é¢ç›ˆè™§ <span class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- åœ–è¡¨å€åŸŸ (èª¿æ•´ç‚ºé›™æŠ˜ç·šåœ–) -->
    <div class="card">
        <h3>ğŸ“ˆ è³‡ç”¢è¶¨å‹¢èˆ‡åˆ†ä½ˆ</h3>
        <div class="grid-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="height: 300px;">
                <canvas id="trendChart1"></canvas>
            </div>
            <div style="height: 300px;">
                <canvas id="trendChart2"></canvas>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;" class="grid-charts">
            <div style="height: 300px;">
                <canvas id="pieChart"></canvas>
            </div>
            <div style="height: 300px;">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>

    <!-- åŒ¯å…¥åŠŸèƒ½ -->
    <div class="card" style="border: 2px dashed var(--primary); background: #f9fbff;">
        <h3>ğŸ“¤ Excel æ•¸æ“šæ‰¹é‡åŒ¯å…¥ (å°ˆæ¥­ç‰ˆé‚è¼¯)</h3>
        <div class="import-grid">
            <div>
                <label><b>1. æœˆä¾›è¨˜éŒ„è¡¨ (v5.0 é‚è¼¯)</b></label>
                <textarea id="excel-buy-area" rows="5" placeholder="è²¼ä¸Šæœˆä¾›è¡¨ç¯„åœ..."></textarea>
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="importBuyData()">åŒ¯å…¥è²·å…¥åŠè‚¡æ¯</button>
            </div>
            <div>
                <label><b>2. è³£å‡ºè‚¡ç¥¨è¡¨ (v5.2 é‚è¼¯ A1:X4)</b></label>
                <textarea id="excel-sell-area" rows="5" placeholder="è²¼ä¸Šè³£å‡ºè¡¨ A1:X4 ç¯„åœ..."></textarea>
                <button class="btn btn-danger" style="width:100%; margin-top:10px;" onclick="importSellData()">åŒ¯å…¥è³£å‡ºè¨˜éŒ„</button>
            </div>
        </div>
    </div>

    <!-- äº¤æ˜“æµæ°´å¸³ -->
    <div class="card">
        <h3>ğŸ—‚ï¸ äº¤æ˜“æµæ°´å¸³ (èˆŠåˆ°æ–°)</h3>
        <div style="max-height: 500px; overflow-y: auto;">
            <table id="history-table">
                <thead>
                    <tr>
                        <th style="width: 15%">æ—¥æœŸ</th>
                        <th style="width: 15%">ä»£è™Ÿ</th>
                        <th style="width: 10%">å‹•ä½œ</th>
                        <th style="width: 12%">å–®åƒ¹</th>
                        <th style="width: 10%">è‚¡æ•¸</th>
                        <th style="width: 12%">æ‰‹çºŒè²»</th>
                        <th style="width: 15%">ç¸½è®Šå‹•</th>
                        <th style="width: 11%"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="margin-top: 10px; text-align: right;">
            <button class="btn btn-sm btn-danger" onclick="clearAllData()">âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>

</div>

<script>
    // --- å…§å»ºè‚¡ç¥¨ä¸­æ–‡åç¨±æ˜ å°„ (æ ¹æ“šç”¨æˆ¶æä¾›) ---
    const stockMap = {
        "0005.HK": "æ»™è±æ§è‚¡", "0012.HK": "æ’åŸºåœ°ç”¢", "0027.HK": "éŠ€æ²³å¨›æ¨‚",
        "0388.HK": "é¦™æ¸¯äº¤æ˜“æ‰€", "0823.HK": "é ˜å±•æˆ¿ç”¢", "0883.HK": "ä¸­æµ·æ²¹",
        "2638.HK": "æ¸¯ç‡ˆ-SS", "2800.HK": "ç›ˆå¯ŒåŸºé‡‘", "0001.HK": "é•·å’Œ",
        "0003.HK": "ç…¤æ°£", "0011.HK": "æ’ç”ŸéŠ€è¡Œ", "0016.HK": "æ–°é´»åŸº",
        "0066.HK": "æ¸¯éµ", "0700.HK": "é¨°è¨Š", "09988.HK": "é˜¿é‡Œ",
        "03690.HK": "ç¾åœ˜", "01299.HK": "å‹é‚¦", "00939.HK": "å»ºè¡Œ",
        "01398.HK": "å·¥è¡Œ", "03988.HK": "ä¸­è¡Œ"
    };

    function getStockName(code) {
        if(!code) return "";
        let c = code.toUpperCase();
        if(!c.includes('.HK')) c += '.HK';
        if(stockMap[c]) return `${c.replace('.HK','')} ${stockMap[c]}`;
        return c;
    }

    // --- å…¨å±€è®Šæ•¸ ---
    let transactions = JSON.parse(localStorage.getItem('stock_v4_trans')) || [];
    let priceCache = JSON.parse(localStorage.getItem('stock_v4_prices')) || {};
    let batchTemplate = JSON.parse(localStorage.getItem('stock_v4_template')) || [];

    // æ’åºç‹€æ…‹
    let portfolioSort = { key: 'marketVal', order: 'desc' };
    let roiSort = { key: 'totalRetPct', order: 'desc' };

    document.getElementById('batch-date').valueAsDate = new Date();
    
    // åˆå§‹åŒ–è¼¸å…¥æ¡†
    if (batchTemplate.length > 0) {
        batchTemplate.forEach(item => addBatchRow(item.code, item.qty, 'buy'));
    } else {
        addBatchRow();
    }

    let trendChartInst1 = null;
    let trendChartInst2 = null;
    let pieChartInst = null;
    let barChartInst = null;

    // å•Ÿå‹•
    renderAll();

    // --- æ ¸å¿ƒè¨ˆç®—å¼•æ“ (é‡è¦æ›´æ–°ï¼šæ‰‹çºŒè²»åˆ†é›¢) ---
    function getPortfolioAnalysis() {
        let p = {};
        transactions.forEach(t => {
            if (!p[t.code]) {
                p[t.code] = { 
                    qty: 0, 
                    currentCost: 0, 
                    totalInvested: 0, // å«è²·å…¥æ‰‹çºŒè²»
                    totalDiv: 0, 
                    soldCash: 0, // æ·¨æ”¶å›ç¾é‡‘ (å·²æ‰£é™¤è³£å‡ºæ‰‹çºŒè²»)
                    soldCost: 0,
                    sellFees: 0, // ç´¯ç©è³£å‡ºæ‰‹çºŒè²»
                    grossSold: 0 // è³£å‡ºç¸½é‡‘é¡ (æœªæ‰£æ‰‹çºŒè²»)
                };
            }
            let stock = p[t.code];

            if (t.type === 'buy') {
                stock.qty += t.qty;
                stock.currentCost += t.total;
                stock.totalInvested += t.total;
            } 
            else if (t.type === 'sell') {
                let avgCost = stock.qty > 0 ? (stock.currentCost / stock.qty) : 0;
                let costOfSoldPart = avgCost * t.qty;
                
                // è¨ˆç®—è³£å‡ºç›¸é—œæ•¸æ“š
                // t.total æ˜¯æ·¨æ”¶å› (åƒ¹æ ¼*è‚¡æ•¸ - æ‰‹çºŒè²»)
                // åæ¨ Gross
                let fee = t.fee || 0;
                let gross = t.total + fee;

                stock.qty -= t.qty;
                stock.currentCost -= costOfSoldPart;
                stock.soldCost += costOfSoldPart;
                stock.soldCash += t.total;
                stock.sellFees += fee;
                stock.grossSold += gross;
            } 
            else if (t.type === 'dividend_cash' || t.type === 'dividend') {
                stock.totalDiv += t.total;
            } 
            else if (t.type === 'dividend_scrip') {
                stock.qty += t.qty;
            }
        });
        return p;
    }

    // --- æ ¼å¼åŒ–å·¥å…· ---
    function fmtMoney(num) {
        return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // --- æ¸²æŸ“ UI ---
    function renderAll() {
        const portfolio = getPortfolioAnalysis();
        renderKPI(portfolio);
        renderPortfolioTable(portfolio);
        renderROITable(portfolio);
        renderHistory();
        renderCharts(portfolio);
    }

    // 1. æ¸²æŸ“ KPI (æ›´æ–°ï¼šç¸½æŠ•å…¥åŒ…å«è³£å‡ºæ‰‹çºŒè²»)
    function renderKPI(p) {
        let totalCost = 0;   // ç›®å‰æŒå€‰æˆæœ¬
        let totalMarket = 0; // ç›®å‰å¸‚å€¼
        let totalDiv = 0;    // ç¸½è‚¡æ¯
        let totalSoldCash = 0; // æ·¨è³£å‡ºå›æ”¶ç¾é‡‘
        let totalInvestedAllTime = 0; // æ­·å²è²·å…¥ç¸½æŠ•å…¥
        let totalSellFees = 0; // ç¸½è³£å‡ºæ‰‹çºŒè²»

        for (let c in p) {
            const s = p[c];
            const price = priceCache[c] || 0;
            totalCost += s.currentCost;
            totalMarket += (s.qty * price);
            totalDiv += s.totalDiv;
            totalSoldCash += s.soldCash;
            totalInvestedAllTime += s.totalInvested;
            totalSellFees += s.sellFees;
        }

        // è«‹æ±‚ï¼šç¸½æŠ•å…¥æˆæœ¬ (æœ¬é‡‘) æ‡‰è©²è¦åŒ…æ‹¬è³£å‡ºè‚¡ç¥¨çš„æ‰‹çºŒè²»
        // å®šç¾©ï¼šä¿®æ­£å¾Œç¸½æŠ•å…¥ = è²·å…¥ç¸½æˆæœ¬ + è³£å‡ºæ‰‹çºŒè²»
        const adjustedTotalInvested = totalInvestedAllTime + totalSellFees;

        // æ·¨å›å ± = (ç›®å‰å¸‚å€¼ + ç¸½è‚¡æ¯ + æ·¨è³£å‡ºå›æ”¶) - è²·å…¥ç¸½æŠ•å…¥
        // æ•¸å­¸ä¸Šç­‰åŒæ–¼ï¼š (å¸‚å€¼ + è‚¡æ¯ + è³£å‡ºGross) - (è²·å…¥æŠ•å…¥ + è³£å‡ºæ‰‹çºŒè²»)
        const totalReturn = (totalMarket + totalDiv + totalSoldCash) - totalInvestedAllTime;
        
        const retPct = adjustedTotalInvested > 0 ? (totalReturn / adjustedTotalInvested * 100) : 0;

        document.getElementById('kpi-cost').textContent = '$' + fmtMoney(adjustedTotalInvested);
        document.getElementById('kpi-market').textContent = '$' + fmtMoney(totalMarket);
        document.getElementById('kpi-div').textContent = '$' + fmtMoney(totalDiv);
        
        const pnlEl = document.getElementById('kpi-pnl');
        pnlEl.textContent = (totalReturn>=0?'+':'') + '$' + fmtMoney(totalReturn);
        pnlEl.className = totalReturn >= 0 ? 'kpi-val text-up' : 'kpi-val text-down'; // ç¶ ç´…è®Šè‰²
        
        const pctEl = document.getElementById('kpi-pnl-pct');
        pctEl.textContent = (retPct>=0?'+':'') + retPct.toFixed(2) + '%';
        pctEl.className = retPct >= 0 ? 'small-text text-up' : 'small-text text-down';
    }

    // 2. æ¸²æŸ“æŒå€‰è¡¨æ ¼ (å«è©³ç´°å±•é–‹)
    function sortPortfolio(key) {
        if (portfolioSort.key === key) {
            portfolioSort.order = portfolioSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            portfolioSort.key = key;
            portfolioSort.order = 'desc';
        }
        renderPortfolioTable(getPortfolioAnalysis());
    }

    function renderPortfolioTable(p) {
        const tbody = document.querySelector('#portfolio-table tbody');
        tbody.innerHTML = '';
        
        let rows = [];
        for (let c in p) {
            const s = p[c];
            if (s.qty <= 0.01) continue;
            const price = priceCache[c] || 0;
            const marketVal = s.qty * price;
            const avgPrice = s.qty > 0 ? (s.currentCost / s.qty) : 0;
            const paperPnl = marketVal - s.currentCost;

            rows.push({
                code: c,
                name: getStockName(c),
                qty: s.qty,
                avgPrice: avgPrice,
                price: price,
                marketVal: marketVal,
                paperPnl: paperPnl,
                data: s // ä¿ç•™åŸå§‹æ•¸æ“šä¾›å±•é–‹ç”¨
            });
        }

        rows.sort((a, b) => {
            let valA = a[portfolioSort.key];
            let valB = b[portfolioSort.key];
            if (typeof valA === 'string') return portfolioSort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            return portfolioSort.order === 'asc' ? valA - valB : valB - valA;
        });

        rows.forEach(r => {
            const rowId = `row-${r.code.replace('.','-')}`;
            tbody.innerHTML += `
                <tr class="clickable-row" onclick="toggleDetail('${rowId}')">
                    <td><b>${r.name}</b><br><span class="small-text">${r.code}</span></td>
                    <td>${r.qty.toFixed(0)}</td>
                    <td>$${fmtMoney(r.avgPrice)}</td>
                    <td><input type="number" value="${r.price}" style="width:80px" onclick="event.stopPropagation()" onchange="updatePrice('${r.code}', this.value)"></td>
                    <td>$${fmtMoney(r.marketVal)}</td>
                    <td class="${r.paperPnl>=0?'text-up':'text-down'}">${r.paperPnl>=0?'+':''}${fmtMoney(r.paperPnl)}</td>
                </tr>
                <tr id="${rowId}" class="detail-row">
                    <td colspan="6">
                        <div class="detail-content">
                            <div class="detail-item"><strong>æŒå€‰æˆæœ¬</strong> $${fmtMoney(r.data.currentCost)}</div>
                            <div class="detail-item"><strong>æ­·å²ç¸½è‚¡æ¯</strong> $${fmtMoney(r.data.totalDiv)}</div>
                            <div class="detail-item"><strong>å·²è®Šç¾é‡‘é¡</strong> $${fmtMoney(r.data.soldCash)}</div>
                            <div class="detail-item"><strong>æ­·å²ç¸½æŠ•å…¥</strong> $${fmtMoney(r.data.totalInvested)}</div>
                            <div class="detail-item"><strong>å·²å¹³å€‰æç›Š</strong> <span class="${(r.data.soldCash - r.data.soldCost)>=0?'text-up':'text-down'}">$${fmtMoney(r.data.soldCash - r.data.soldCost)}</span></div>
                            <div class="detail-item"><strong>è³£å‡ºæ‰‹çºŒè²»</strong> $${fmtMoney(r.data.sellFees)}</div>
                        </div>
                    </td>
                </tr>
            `;
        });
        updateSortIcons('portfolio-table', portfolioSort);
    }

    function toggleDetail(id) {
        const row = document.getElementById(id);
        if(row.style.display === 'table-row') row.style.display = 'none';
        else row.style.display = 'table-row';
    }

    // 3. æ¸²æŸ“ ROI æ’è¡Œæ¦œ
    function sortRoi(key) {
        if (roiSort.key === key) {
            roiSort.order = roiSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            roiSort.key = key;
            roiSort.order = 'desc';
        }
        renderROITable(getPortfolioAnalysis());
    }

    function renderROITable(p) {
        const tbody = document.querySelector('#roi-table tbody');
        tbody.innerHTML = '';

        let rows = [];
        for (let c in p) {
            const s = p[c];
            if (s.totalInvested === 0 && s.qty === 0 && s.totalDiv === 0) continue;

            const price = priceCache[c] || 0;
            const marketVal = s.qty * price;
            const realizedPnl = s.soldCash - s.soldCost;
            const totalProfit = (marketVal + s.totalDiv + s.soldCash) - s.totalInvested;
            
            // ä¿®æ­£ï¼šåˆ†æ¯ç”¨ Adjusted Invested (è²·å…¥æˆæœ¬+è³£å‡ºè²»)
            const adjustedInv = s.totalInvested + s.sellFees;
            
            const yieldRate = adjustedInv > 0 ? (s.totalDiv / adjustedInv) * 100 : 0;
            const totalRetPct = adjustedInv > 0 ? (totalProfit / adjustedInv) * 100 : 0;

            rows.push({
                code: c,
                name: getStockName(c),
                totalInvested: adjustedInv, // é¡¯ç¤ºå«æ‰‹çºŒè²»çš„ç¸½æŠ•å…¥
                totalDiv: s.totalDiv,
                realizedPnl: realizedPnl,
                yield: yieldRate,
                totalRetPct: totalRetPct,
                totalProfit: totalProfit
            });
        }

        rows.sort((a, b) => {
            let valA = a[roiSort.key];
            let valB = b[roiSort.key];
            if (typeof valA === 'string') return roiSort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            return roiSort.order === 'asc' ? valA - valB : valB - valA;
        });

        rows.forEach((r, idx) => {
            let badge = '';
            if (roiSort.key === 'totalRetPct' && roiSort.order === 'desc') {
                if (idx === 0) badge = '<span class="badge bg-gold">1</span> ';
                if (idx === 1) badge = '<span class="badge bg-gray">2</span> ';
                if (idx === 2) badge = '<span class="badge bg-bronze">3</span> ';
            }

            tbody.innerHTML += `
                <tr>
                    <td>${badge}<b>${r.name}</b><br><span class="small-text">${r.code}</span></td>
                    <td>$${fmtMoney(r.totalInvested)}</td>
                    <td>$${fmtMoney(r.totalDiv)}</td>
                    <td class="${r.realizedPnl>=0?'text-up':'text-down'}">${r.realizedPnl>=0?'+':''}${fmtMoney(r.realizedPnl)}</td>
                    <td class="text-up">${r.yield.toFixed(2)}%</td>
                    <td class="${r.totalProfit>=0?'text-up':'text-down'}"><b>${r.totalProfit>=0?'+':''}${fmtMoney(r.totalProfit)}</b></td>
                    <td class="${r.totalRetPct>=0?'text-up':'text-down'}"><b>${r.totalRetPct>=0?'+':''}${r.totalRetPct.toFixed(2)}%</b></td>
                </tr>
            `;
        });
        updateSortIcons('roi-table', roiSort);
    }

    function updateSortIcons(tableId, sortState) {
        document.querySelectorAll(`#${tableId} th`).forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.getAttribute('onclick') && th.getAttribute('onclick').includes(`'${sortState.key}'`)) {
                th.classList.add(sortState.order === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        });
    }

    // --- åœ–è¡¨åŠŸèƒ½ (èª¿æ•´ï¼šé›™æŠ˜ç·šåœ– & åœ“é¤…åœ–æ¯”ä¾‹) ---
    function renderCharts(p) {
        const dates = [...new Set(transactions.map(t => t.date.substring(0,7)))].sort();
        
        let accRealizedPnl = 0; // ç´¯ç©å¹³å€‰æç›Š
        let accDiv = 0;         // ç´¯ç©è‚¡æ¯
        let accHoldingCost = 0; // æŒå€‰æˆæœ¬ (è²·å…¥ - è³£å‡ºæˆæœ¬)
        
        let dataRealized = [], dataDiv = [], dataHoldingCost = [];
        
        let sorted = [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date));
        let monthly = {};
        
        // ç‚ºäº†è¨ˆç®—æº–ç¢ºï¼Œéœ€å»ºç«‹è‡¨æ™‚æŒå€‰æ± ä¾†è¨ˆç®—è³£å‡ºæˆæœ¬
        let tempStock = {}; 

        sorted.forEach(t => {
            let m = t.date.substring(0,7);
            
            // ç¢ºä¿ç‰©ä»¶å­˜åœ¨
            if(!tempStock[t.code]) tempStock[t.code] = { qty:0, cost:0 };
            let ts = tempStock[t.code];

            if(t.type === 'buy') {
                ts.qty += t.qty;
                ts.cost += t.total;
                accHoldingCost += t.total;
            }
            else if(t.type === 'dividend_cash') {
                accDiv += t.total;
            }
            else if(t.type === 'dividend_scrip') {
                ts.qty += t.qty;
            }
            else if(t.type === 'sell') {
                let avg = ts.qty > 0 ? ts.cost / ts.qty : 0;
                let costPart = avg * t.qty;
                
                // ç´¯ç©å¹³å€‰æç›Š = è³£å‡ºæ·¨å›æ”¶ - æˆæœ¬
                let pnl = t.total - costPart;
                accRealizedPnl += pnl;

                // æŒå€‰æˆæœ¬æ¸›å°‘
                ts.qty -= t.qty;
                ts.cost -= costPart;
                accHoldingCost -= costPart;
            }

            monthly[m] = { realized: accRealizedPnl, div: accDiv, holding: accHoldingCost };
        });

        dates.forEach(m => {
            let lastR = dataRealized.length ? dataRealized[dataRealized.length-1] : 0;
            let lastD = dataDiv.length ? dataDiv[dataDiv.length-1] : 0;
            let lastH = dataHoldingCost.length ? dataHoldingCost[dataHoldingCost.length-1] : 0;
            
            if(monthly[m]) {
                dataRealized.push(monthly[m].realized);
                dataDiv.push(monthly[m].div);
                dataHoldingCost.push(monthly[m].holding);
            } else {
                dataRealized.push(lastR);
                dataDiv.push(lastD);
                dataHoldingCost.push(lastH);
            }
        });

        // Chart 1: å¹³å€‰å›å ± vs è‚¡æ¯
        if(trendChartInst1) trendChartInst1.destroy();
        trendChartInst1 = new Chart(document.getElementById('trendChart1'), {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    { label: 'ç´¯ç©å¹³å€‰å›å ± (å·²å¯¦ç¾æç›Š)', data: dataRealized, borderColor: '#722ed1', backgroundColor: 'rgba(114,46,209,0.1)', fill: true },
                    { label: 'ç´¯ç©è‚¡æ¯æ”¶å…¥', data: dataDiv, borderColor: '#52c41a', backgroundColor: 'rgba(82,196,26,0.1)', fill: true }
                ]
            },
            options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'å›å ±è¶¨å‹¢ (å¹³å€‰ vs è‚¡æ¯)' } } }
        });

        // Chart 2: æŒå€‰æˆæœ¬è¶¨å‹¢
        if(trendChartInst2) trendChartInst2.destroy();
        trendChartInst2 = new Chart(document.getElementById('trendChart2'), {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    { label: 'ç¸½æŒå€‰æˆæœ¬è¶¨å‹¢', data: dataHoldingCost, borderColor: '#1890ff', backgroundColor: 'rgba(24,144,255,0.1)', fill: true }
                ]
            },
            options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'æŒå€‰è¦æ¨¡è¶¨å‹¢ (æˆæœ¬æ³•)' } } }
        });

        // Pie Chart: ä½”æ¯” (å«ç™¾åˆ†æ¯” Label)
        if(pieChartInst) pieChartInst.destroy();
        let labels = [], data = [];
        let totalVal = 0;
        
        for(let c in p) { 
            if(p[c].qty>0) { 
                let v = p[c].qty * (priceCache[c]||0);
                totalVal += v;
            } 
        }

        for(let c in p) { 
            if(p[c].qty>0) { 
                let v = p[c].qty * (priceCache[c]||0);
                let pct = totalVal > 0 ? Math.round((v/totalVal)*100) : 0;
                labels.push(`${getStockName(c).replace(/[0-9.]/g,'').substring(0,4) || c} (${pct}%)`);
                data.push(v); 
            } 
        }

        pieChartInst = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: ['#1890ff','#13c2c2','#52c41a','#fadb14','#f5222d','#722ed1','#eb2f96','#fa8c16'] }] },
            options: { 
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });

        // Bar Chart
        if(barChartInst) barChartInst.destroy();
        let yearly = {};
        sorted.forEach(t => {
            if(t.type.includes('dividend') && !t.type.includes('scrip')) {
                let y = t.date.substring(0,4);
                yearly[y] = (yearly[y]||0) + t.total;
            }
        });
        barChartInst = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: Object.keys(yearly), datasets: [{ label: 'å¹´åº¦è‚¡æ¯æ”¶å…¥', data: Object.values(yearly), backgroundColor: '#13c2c2' }] },
            options: { maintainAspectRatio: false }
        });
    }

    // --- äº¤æ˜“è¨˜éŒ„ ---
    function renderHistory() {
        const tbody = document.querySelector('#history-table tbody');
        tbody.innerHTML = '';
        const list = [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        let currentMonth = '';

        list.forEach(t => {
            const m = t.date.substring(0, 7);
            if (m !== currentMonth) {
                currentMonth = m;
                tbody.innerHTML += `<tr class="history-month-row"><td colspan="8">${m.replace('-', 'å¹´')}æœˆ</td></tr>`;
            }

            let act = '', valClass = '';
            if(t.type==='buy') { act='è²·å…¥'; valClass='text-down'; }
            else if(t.type==='sell') { act='è³£å‡º'; valClass='text-up'; }
            else if(t.type.includes('cash')) { act='æ”¶æ¯(éŒ¢)'; valClass='text-up'; }
            else if(t.type.includes('scrip')) { act='æ”¶æ¯(è²¨)'; valClass='text-up'; }
            
            let priceStr = t.price ? `$${fmtMoney(t.price)}` : '-';
            let qtyStr = t.qty ? t.qty : '-';
            let feeStr = t.fee ? `$${fmtMoney(t.fee)}` : '-';
            let totalStr = '';

            if (t.type === 'buy') totalStr = `-$${fmtMoney(t.total)}`;
            else if (t.type === 'dividend_scrip') totalStr = `+${t.qty}è‚¡`;
            else totalStr = `+$${fmtMoney(t.total)}`;

            tbody.innerHTML += `
                <tr>
                    <td>${t.date}</td>
                    <td><b>${getStockName(t.code)}</b><br><span class="small-text">${t.code}</span></td>
                    <td>${act}</td>
                    <td>${priceStr}</td>
                    <td>${qtyStr}</td>
                    <td class="small-text">${feeStr}</td>
                    <td class="${valClass}" style="font-weight:bold">${totalStr}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="delTrans(${t.id})">X</button></td>
                </tr>
            `;
        });
    }

    // --- è¼”åŠ©åŠŸèƒ½ (ç„¡éœ€è®Šæ›´å¤ªå¤š) ---
    function addBatchRow(code='', qty='', type='buy') {
        const tbody = document.getElementById('batch-body');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <select class="row-type" onchange="handleTypeChange(this)">
                    <option value="buy" ${type==='buy'?'selected':''}>è²·å…¥</option>
                    <option value="dividend_cash">æ”¶æ¯ (æ´¾éŒ¢)</option>
                    <option value="dividend_scrip">æ”¶æ¯ (æ´¾è²¨)</option>
                    <option value="sell">è³£å‡º</option>
                </select>
            </td>
            <td><input type="text" class="row-code" value="${code}" placeholder="0005.HK" oninput="this.value=this.value.toUpperCase()"></td>
            <td><input type="number" class="row-price" step="0.01" placeholder="å–®åƒ¹"></td>
            <td><input type="number" class="row-qty" value="${qty}" placeholder="è‚¡æ•¸"></td>
            <td><button class="btn btn-danger" style="padding:5px;" onclick="this.closest('tr').remove()">X</button></td>
        `;
        tbody.appendChild(tr);
        handleTypeChange(tr.querySelector('.row-type'));
    }

    function handleTypeChange(select) {
        const tr = select.closest('tr');
        const priceInp = tr.querySelector('.row-price');
        const qtyInp = tr.querySelector('.row-qty');
        const type = select.value;
        priceInp.disabled = false; qtyInp.disabled = false;
        priceInp.value = ''; qtyInp.value = '';
        if(type === 'dividend_cash') {
            priceInp.placeholder = "ç¸½é‡‘é¡ ($)"; qtyInp.disabled = true; qtyInp.placeholder = "-";
        } else if(type === 'dividend_scrip') {
            priceInp.disabled = true; priceInp.placeholder = "0"; qtyInp.placeholder = "æ”¶åˆ°è‚¡æ•¸";
        } else {
            priceInp.placeholder = "å–®åƒ¹"; qtyInp.placeholder = "è‚¡æ•¸";
        }
    }

    function saveBatchTransaction() {
        const date = document.getElementById('batch-date').value;
        const globalFee = parseFloat(document.getElementById('batch-fee').value) || 0;
        const rows = document.querySelectorAll('#batch-body tr');
        let newTrans = [];
        let totalBuyVal = 0;
        let template = [];
        rows.forEach(tr => {
            const type = tr.querySelector('.row-type').value;
            let code = tr.querySelector('.row-code').value.trim();
            const val1 = parseFloat(tr.querySelector('.row-price').value) || 0;
            const val2 = parseFloat(tr.querySelector('.row-qty').value) || 0;
            if(!code) return;
            if(!code.includes('.')) code += '.HK';
            let t = { id: Date.now()+Math.random(), date, type, code, price:0, qty:0, total:0, fee:0 };
            if(type === 'buy') {
                t.price = val1; t.qty = val2; t.total = val1*val2; totalBuyVal += t.total; template.push({code, qty: val2});
            } else if(type === 'sell') {
                t.price = val1; t.qty = val2; t.total = val1*val2; 
            } else if(type === 'dividend_cash') {
                t.total = val1;
            } else if(type === 'dividend_scrip') {
                t.qty = val2;
            }
            newTrans.push(t);
        });
        if(newTrans.length === 0) return;
        newTrans.forEach(t => {
            if(t.type === 'buy' && totalBuyVal > 0) { t.fee = globalFee * (t.total / totalBuyVal); t.total += t.fee; }
            if(t.type === 'sell') { 
                // è³£å‡ºæ‰‹çºŒè²»é‚è¼¯ï¼šå¦‚æœç”¨æˆ¶åœ¨æ‰¹é‡è¼¸å…¥è£¡è³£å‡ºï¼Œé€™è£¡ç„¡æ³•å¾—çŸ¥è©²æ¬¡è³£å‡ºçš„æº–ç¢ºæ‰‹çºŒè²»åˆ†é…
                // å‡è¨­ globalFee å°è³£å‡ºä¹Ÿç”Ÿæ•ˆï¼Ÿé€šå¸¸ç”¨æˆ¶ä¸æœƒåŒæ™‚æ··å’Œè¼¸å…¥è²·è³£ã€‚
                // é€™è£¡ç°¡å–®è™•ç†ï¼šå¦‚æœæ˜¯è³£å‡ºï¼Œå°‡ globalFee å¾å›æ”¶é‡‘é¡ä¸­æ‰£é™¤ (totalè®Šå°)
                // é€™è£¡ t.total ç›®å‰æ˜¯ Gross. 
                // æˆ‘å€‘çµ±ä¸€é‚è¼¯ï¼št.total åœ¨ DB å­˜çš„æ˜¯ã€Œæ·¨ç¾é‡‘æµã€
                // æ‰€ä»¥ Buy: total = Cost + Fee (è² å‘ç¾é‡‘æµçš„çµ•å°å€¼)
                // Sell: total = Revenue - Fee (æ­£å‘ç¾é‡‘æµ)
                // é€™è£¡å¦‚æœæ˜¯ Sell, t.total = val1*val2 (Gross). 
                // ç‚ºäº†ä¿æŒä¸€è‡´ï¼Œå¦‚æœç”¨æˆ¶è¼¸å…¥äº†æ‰‹çºŒè²»ï¼Œæˆ‘å€‘æ‰£é™¤å®ƒã€‚
                // *æ³¨æ„*ï¼šå¦‚æœä¸Šæ–¹è¼¸å…¥äº†æ‰‹çºŒè²»ï¼Œæœƒå¾è³£å‡ºé‡‘é¡æ‰£é™¤ã€‚
                if(t.price > 0 && globalFee > 0) {
                     t.fee = globalFee; // å‡è¨­å–®ç­†è³£å‡ºå…¨åƒ
                     t.total -= t.fee;
                }
            }
        });
        transactions = transactions.concat(newTrans);
        transactions.sort((a,b) => new Date(a.date) - new Date(b.date));
        saveAndRefresh();
        if(template.length>0) localStorage.setItem('stock_v4_template', JSON.stringify(template));
        document.getElementById('batch-body').innerHTML = '';
        if(template.length>0) template.forEach(x => addBatchRow(x.code, x.qty)); else addBatchRow();
        alert("å·²å„²å­˜è¨˜éŒ„ï¼");
    }

    function saveAndRefresh() { 
        localStorage.setItem('stock_v4_trans', JSON.stringify(transactions)); 
        renderAll(); 
    }
    function updatePrice(code, val) {
        priceCache[code] = parseFloat(val);
        localStorage.setItem('stock_v4_prices', JSON.stringify(priceCache));
        renderAll();
    }
    async function fetchYahooPrices() {
        const p = getPortfolioAnalysis();
        const codes = Object.keys(p).filter(c => p[c].qty > 0);
        if (codes.length === 0) return alert("ç›®å‰æ²’æœ‰æŒå€‰éœ€è¦æ›´æ–°");
        let updated = 0;
        for (let code of codes) {
            try {
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${code}?interval=1d&range=1d`;
                const res = await fetch(url);
                const data = await res.json();
                const price = data.chart.result[0].meta.regularMarketPrice;
                if(price) { priceCache[code] = price; updated++; }
            } catch(e) { console.error(code, e); }
        }
        localStorage.setItem('stock_v4_prices', JSON.stringify(priceCache));
        renderAll();
        alert(`å·²æ›´æ–° ${updated} éš»è‚¡ç¥¨åƒ¹æ ¼`);
    }

    function importBuyData() {
        const raw = document.getElementById('excel-buy-area').value;
        if(!raw) return;
        const lines = raw.split('\n').map(l => l.split('\t'));
        const header = lines[0];
        let newItems = [];
        let stockCols = [];
        for(let col=0; col < header.length; col++) {
            let code = header[col] ? header[col].trim() : '';
            if(code && (code.includes('.') || !isNaN(code)) && code !== 'æ—¥æœŸ' && code !== 'æ‰‹çºŒè²»') {
                 if(!code.includes('.')) code += ".HK";
                 stockCols.push({ index: col, code: code });
            }
        }
        for(let i=1; i<lines.length; i++) {
            const r = lines[i];
            if(!r[0] || r[0].includes('å¹´')) continue;
            const date = r[0].trim().replace(/\//g, '-');
            const rowTotalFee = parseFloat(r[1]) || 0;
            let rowBuys = [];
            let rowBuyValue = 0;
            stockCols.forEach(sc => {
                const qty = parseFloat(r[sc.index]) || 0;
                let priceRaw = r[sc.index+1];
                if (typeof priceRaw === 'string') priceRaw = priceRaw.trim();
                const price = parseFloat(priceRaw) || 0;
                const div = parseFloat(r[sc.index+3]) || 0;
                if(qty > 0) {
                    if (price > 0) {
                        rowBuys.push({ code: sc.code, qty, price, rawTotal: qty*price });
                        rowBuyValue += (qty*price);
                    } else {
                         newItems.push({ id: Math.random(), date, type: 'dividend_scrip', code: sc.code, qty: qty, price: 0, total: 0, fee: 0 });
                    }
                }
                if(div > 0) newItems.push({ id: Math.random(), date, type: 'dividend_cash', code: sc.code, qty: 0, price: 0, total: div, fee: 0 });
            });
            rowBuys.forEach(b => {
                let allocatedFee = 0;
                if(rowBuyValue > 0) allocatedFee = rowTotalFee * (b.rawTotal / rowBuyValue);
                newItems.push({ id: Math.random(), date, type: 'buy', code: b.code, qty: b.qty, price: b.price, total: b.rawTotal + allocatedFee, fee: allocatedFee });
            });
        }
        transactions = [...transactions, ...newItems].sort((a,b)=>new Date(a.date)-new Date(b.date));
        saveAndRefresh();
        alert(`åŒ¯å…¥æˆåŠŸï¼å·²åŠ å…¥ ${newItems.length} ç­†è¨˜éŒ„ã€‚`);
        document.getElementById('excel-buy-area').value = '';
    }

    function importSellData() {
        const raw = document.getElementById('excel-sell-area').value;
        if(!raw) return;
        const lines = raw.split('\n').map(l => l.split('\t'));
        let newSells = [];
        for (let col = 0; col < lines[0].length; col += 4) {
            let code = lines[0][col] ? lines[0][col].trim() : "";
            if (!code || isNaN(code)) continue;
            if (!code.includes('.')) code += ".HK";
            for (let i = 2; i < lines.length; i++) {
                const r = lines[i];
                const date = r[col] ? r[col].trim().replace(/\//g, '-') : "";
                if (!date || date === "æ—¥æœŸ") continue;
                const fee = Math.abs(parseFloat(r[col+1])) || 0;
                const qty = Math.abs(parseFloat(r[col+2])) || 0;
                const price = parseFloat(r[col+3]) || 0;
                if (qty > 0 && price > 0) {
                    newSells.push({ id: Math.random(), date, type: 'sell', code, qty, price, total: (qty * price) - fee, fee });
                }
            }
        }
        transactions = [...transactions, ...newSells].sort((a,b)=>new Date(a.date)-new Date(b.date));
        saveAndRefresh();
        alert(`æˆåŠŸåŒ¯å…¥ ${newSells.length} ç­†è³£å‡ºè¨˜éŒ„`);
        document.getElementById('excel-sell-area').value = '';
    }

    function delTrans(id) {
        if(confirm("åˆªé™¤æ­¤è¨˜éŒ„ï¼Ÿ")) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('stock_v4_trans', JSON.stringify(transactions));
            renderAll();
        }
    }
    function clearAllData() {
        if(confirm("âš ï¸ ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿç„¡æ³•å¾©åŸï¼")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>